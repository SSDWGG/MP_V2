!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MuduRTC=t()}(this,(function(){"use strict";!function(){const e={NODE_ENV:"production"};try{if(process)return process.env=Object.assign({},process.env),void Object.assign(process.env,e)}catch(e){}globalThis.process={env:e}}();function e(e,t){return Promise.resolve(e.filter((e=>e.kind===t)))}var t="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}var i=r,n=s;function a(e){if(i===setTimeout)return setTimeout(e,0);if((i===r||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}"function"==typeof t.setTimeout&&(i=setTimeout),"function"==typeof t.clearTimeout&&(n=clearTimeout);var o,c=[],d=!1,p=-1;function l(){d&&o&&(d=!1,o.length?c=o.concat(c):p=-1,c.length&&h())}function h(){if(!d){var e=a(l);d=!0;for(var t=c.length;t;){for(o=c,c=[];++p<t;)o&&o[p].run();p=-1,t=c.length}o=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function u(e,t){this.fun=e,this.array=t}u.prototype.run=function(){this.fun.apply(null,this.array)};function m(){}var f=m,g=m,y=m,_=m,b=m,v=m,w=m;var S=t.performance||{},R=S.now||S.mozNow||S.msNow||S.oNow||S.webkitNow||function(){return(new Date).getTime()};var P=new Date;var T={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new u(e,t)),1!==c.length||d||a(h)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:f,addListener:g,once:y,off:_,removeListener:b,removeAllListeners:v,emit:w,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*R.call(S),r=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(r-=e[0],(s-=e[1])<0&&(r--,s+=1e9)),[r,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-P)/1e3}},C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function k(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})})),t}var E={exports:{}},D={exports:{}},x=1e3,O=60*x,M=60*O,I=24*M,j=7*I,L=365.25*I,A=function(e,t){t=t||{};var r=typeof e;if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var r=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*L;case"weeks":case"week":case"w":return r*j;case"days":case"day":case"d":return r*I;case"hours":case"hour":case"hrs":case"hr":case"h":return r*M;case"minutes":case"minute":case"mins":case"min":case"m":return r*O;case"seconds":case"second":case"secs":case"sec":case"s":return r*x;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}(e);if("number"===r&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=I)return B(e,t,I,"day");if(t>=M)return B(e,t,M,"hour");if(t>=O)return B(e,t,O,"minute");if(t>=x)return B(e,t,x,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=I)return Math.round(e/I)+"d";if(t>=M)return Math.round(e/M)+"h";if(t>=O)return Math.round(e/O)+"m";if(t>=x)return Math.round(e/x)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function B(e,t,r,s){var i=t>=1.5*r;return Math.round(e/r)+" "+s+(i?"s":"")}var F=function(e){function t(e){let s,i,n,a=null;function o(...e){if(!o.enabled)return;const r=o,i=Number(new Date),n=i-(s||i);r.diff=n,r.prev=s,r.curr=i,s=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((s,i)=>{if("%%"===s)return"%";a++;const n=t.formatters[i];if("function"==typeof n){const t=e[a];s=n.call(r,t),e.splice(a,1),a--}return s})),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=r,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(i!==t.namespaces&&(i=t.namespaces,n=t.enabled(e)),n),set:e=>{a=e}}),"function"==typeof t.init&&t.init(o),o}function r(e,r){const s=t(this.namespace+(void 0===r?":":r)+e);return s.log=this.log,s}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const s=("string"==typeof e?e:"").split(/[\s,]+/),i=s.length;for(r=0;r<i;r++)s[r]&&("-"===(e=s[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,s;for(r=0,s=t.skips.length;r<s;r++)if(t.skips[r].test(e))return!1;for(r=0,s=t.names.length;r<s;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=A,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let s=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(s++,"%c"===e&&(i=s))})),t.splice(i,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==T&&"env"in T&&(e=T.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=F(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(D,D.exports);var N={exports:{}};function U(){return!1}function z(){throw new Error("tty.ReadStream is not implemented")}function $(){throw new Error("tty.ReadStream is not implemented")}var V={isatty:U,ReadStream:z,WriteStream:$},q=k(Object.freeze({__proto__:null,isatty:U,ReadStream:z,WriteStream:$,default:V})),G=[],H=[],W="undefined"!=typeof Uint8Array?Uint8Array:Array,K=!1;function Y(){K=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0,r=e.length;t<r;++t)G[t]=e[t],H[e.charCodeAt(t)]=t;H["-".charCodeAt(0)]=62,H["_".charCodeAt(0)]=63}function Q(e,t,r){for(var s,i,n=[],a=t;a<r;a+=3)s=(e[a]<<16)+(e[a+1]<<8)+e[a+2],n.push(G[(i=s)>>18&63]+G[i>>12&63]+G[i>>6&63]+G[63&i]);return n.join("")}function J(e){var t;K||Y();for(var r=e.length,s=r%3,i="",n=[],a=16383,o=0,c=r-s;o<c;o+=a)n.push(Q(e,o,o+a>c?c:o+a));return 1===s?(t=e[r-1],i+=G[t>>2],i+=G[t<<4&63],i+="=="):2===s&&(t=(e[r-2]<<8)+e[r-1],i+=G[t>>10],i+=G[t>>4&63],i+=G[t<<2&63],i+="="),n.push(i),n.join("")}function Z(e,t,r,s,i){var n,a,o=8*i-s-1,c=(1<<o)-1,d=c>>1,p=-7,l=r?i-1:0,h=r?-1:1,u=e[t+l];for(l+=h,n=u&(1<<-p)-1,u>>=-p,p+=o;p>0;n=256*n+e[t+l],l+=h,p-=8);for(a=n&(1<<-p)-1,n>>=-p,p+=s;p>0;a=256*a+e[t+l],l+=h,p-=8);if(0===n)n=1-d;else{if(n===c)return a?NaN:1/0*(u?-1:1);a+=Math.pow(2,s),n-=d}return(u?-1:1)*a*Math.pow(2,n-s)}function X(e,t,r,s,i,n){var a,o,c,d=8*n-i-1,p=(1<<d)-1,l=p>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,u=s?0:n-1,m=s?1:-1,f=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,a=p):(a=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-a))<1&&(a--,c*=2),(t+=a+l>=1?h/c:h*Math.pow(2,1-l))*c>=2&&(a++,c/=2),a+l>=p?(o=0,a=p):a+l>=1?(o=(t*c-1)*Math.pow(2,i),a+=l):(o=t*Math.pow(2,l-1)*Math.pow(2,i),a=0));i>=8;e[r+u]=255&o,u+=m,o/=256,i-=8);for(a=a<<i|o,d+=i;d>0;e[r+u]=255&a,u+=m,a/=256,d-=8);e[r+u-m]|=128*f}var ee={}.toString,te=Array.isArray||function(e){return"[object Array]"==ee.call(e)};function re(){return ie.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function se(e,t){if(re()<t)throw new RangeError("Invalid typed array length");return ie.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=ie.prototype:(null===e&&(e=new ie(t)),e.length=t),e}function ie(e,t,r){if(!(ie.TYPED_ARRAY_SUPPORT||this instanceof ie))return new ie(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return oe(this,e)}return ne(this,e,t,r)}function ne(e,t,r,s){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,s){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(s||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===s?new Uint8Array(t):void 0===s?new Uint8Array(t,r):new Uint8Array(t,r,s);ie.TYPED_ARRAY_SUPPORT?(e=t).__proto__=ie.prototype:e=ce(e,t);return e}(e,t,r,s):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!ie.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var s=0|le(t,r),i=(e=se(e,s)).write(t,r);i!==s&&(e=e.slice(0,i));return e}(e,t,r):function(e,t){if(pe(t)){var r=0|de(t.length);return 0===(e=se(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(s=t.length)!=s?se(e,0):ce(e,t);if("Buffer"===t.type&&te(t.data))return ce(e,t.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function ae(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function oe(e,t){if(ae(t),e=se(e,t<0?0:0|de(t)),!ie.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function ce(e,t){var r=t.length<0?0:0|de(t.length);e=se(e,r);for(var s=0;s<r;s+=1)e[s]=255&t[s];return e}function de(e){if(e>=re())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+re().toString(16)+" bytes");return 0|e}function pe(e){return!(null==e||!e._isBuffer)}function le(e,t){if(pe(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return Fe(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return Ne(e).length;default:if(s)return Fe(e).length;t=(""+t).toLowerCase(),s=!0}}function he(e,t,r){var s=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return ke(this,t,r);case"utf8":case"utf-8":return Re(this,t,r);case"ascii":return Te(this,t,r);case"latin1":case"binary":return Ce(this,t,r);case"base64":return Se(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ee(this,t,r);default:if(s)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),s=!0}}function ue(e,t,r){var s=e[t];e[t]=e[r],e[r]=s}function me(e,t,r,s,i){if(0===e.length)return-1;if("string"==typeof r?(s=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=ie.from(t,s)),pe(t))return 0===t.length?-1:fe(e,t,r,s,i);if("number"==typeof t)return t&=255,ie.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):fe(e,[t],r,s,i);throw new TypeError("val must be string, number or Buffer")}function fe(e,t,r,s,i){var n,a=1,o=e.length,c=t.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(e.length<2||t.length<2)return-1;a=2,o/=2,c/=2,r/=2}function d(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(i){var p=-1;for(n=r;n<o;n++)if(d(e,n)===d(t,-1===p?0:n-p)){if(-1===p&&(p=n),n-p+1===c)return p*a}else-1!==p&&(n-=n-p),p=-1}else for(r+c>o&&(r=o-c),n=r;n>=0;n--){for(var l=!0,h=0;h<c;h++)if(d(e,n+h)!==d(t,h)){l=!1;break}if(l)return n}return-1}function ge(e,t,r,s){r=Number(r)||0;var i=e.length-r;s?(s=Number(s))>i&&(s=i):s=i;var n=t.length;if(n%2!=0)throw new TypeError("Invalid hex string");s>n/2&&(s=n/2);for(var a=0;a<s;++a){var o=parseInt(t.substr(2*a,2),16);if(isNaN(o))return a;e[r+a]=o}return a}function ye(e,t,r,s){return Ue(Fe(t,e.length-r),e,r,s)}function _e(e,t,r,s){return Ue(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,s)}function be(e,t,r,s){return _e(e,t,r,s)}function ve(e,t,r,s){return Ue(Ne(t),e,r,s)}function we(e,t,r,s){return Ue(function(e,t){for(var r,s,i,n=[],a=0;a<e.length&&!((t-=2)<0);++a)s=(r=e.charCodeAt(a))>>8,i=r%256,n.push(i),n.push(s);return n}(t,e.length-r),e,r,s)}function Se(e,t,r){return 0===t&&r===e.length?J(e):J(e.slice(t,r))}function Re(e,t,r){r=Math.min(e.length,r);for(var s=[],i=t;i<r;){var n,a,o,c,d=e[i],p=null,l=d>239?4:d>223?3:d>191?2:1;if(i+l<=r)switch(l){case 1:d<128&&(p=d);break;case 2:128==(192&(n=e[i+1]))&&(c=(31&d)<<6|63&n)>127&&(p=c);break;case 3:n=e[i+1],a=e[i+2],128==(192&n)&&128==(192&a)&&(c=(15&d)<<12|(63&n)<<6|63&a)>2047&&(c<55296||c>57343)&&(p=c);break;case 4:n=e[i+1],a=e[i+2],o=e[i+3],128==(192&n)&&128==(192&a)&&128==(192&o)&&(c=(15&d)<<18|(63&n)<<12|(63&a)<<6|63&o)>65535&&c<1114112&&(p=c)}null===p?(p=65533,l=1):p>65535&&(p-=65536,s.push(p>>>10&1023|55296),p=56320|1023&p),s.push(p),i+=l}return function(e){var t=e.length;if(t<=Pe)return String.fromCharCode.apply(String,e);var r="",s=0;for(;s<t;)r+=String.fromCharCode.apply(String,e.slice(s,s+=Pe));return r}(s)}ie.TYPED_ARRAY_SUPPORT=void 0===t.TYPED_ARRAY_SUPPORT||t.TYPED_ARRAY_SUPPORT,ie.poolSize=8192,ie._augment=function(e){return e.__proto__=ie.prototype,e},ie.from=function(e,t,r){return ne(null,e,t,r)},ie.TYPED_ARRAY_SUPPORT&&(ie.prototype.__proto__=Uint8Array.prototype,ie.__proto__=Uint8Array),ie.alloc=function(e,t,r){return function(e,t,r,s){return ae(t),t<=0?se(e,t):void 0!==r?"string"==typeof s?se(e,t).fill(r,s):se(e,t).fill(r):se(e,t)}(null,e,t,r)},ie.allocUnsafe=function(e){return oe(null,e)},ie.allocUnsafeSlow=function(e){return oe(null,e)},ie.isBuffer=function(e){return null!=e&&(!!e._isBuffer||ze(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&ze(e.slice(0,0))}(e))},ie.compare=function(e,t){if(!pe(e)||!pe(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,s=t.length,i=0,n=Math.min(r,s);i<n;++i)if(e[i]!==t[i]){r=e[i],s=t[i];break}return r<s?-1:s<r?1:0},ie.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ie.concat=function(e,t){if(!te(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return ie.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var s=ie.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var n=e[r];if(!pe(n))throw new TypeError('"list" argument must be an Array of Buffers');n.copy(s,i),i+=n.length}return s},ie.byteLength=le,ie.prototype._isBuffer=!0,ie.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)ue(this,t,t+1);return this},ie.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)ue(this,t,t+3),ue(this,t+1,t+2);return this},ie.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)ue(this,t,t+7),ue(this,t+1,t+6),ue(this,t+2,t+5),ue(this,t+3,t+4);return this},ie.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Re(this,0,e):he.apply(this,arguments)},ie.prototype.equals=function(e){if(!pe(e))throw new TypeError("Argument must be a Buffer");return this===e||0===ie.compare(this,e)},ie.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},ie.prototype.compare=function(e,t,r,s,i){if(!pe(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===s&&(s=0),void 0===i&&(i=this.length),t<0||r>e.length||s<0||i>this.length)throw new RangeError("out of range index");if(s>=i&&t>=r)return 0;if(s>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var n=(i>>>=0)-(s>>>=0),a=(r>>>=0)-(t>>>=0),o=Math.min(n,a),c=this.slice(s,i),d=e.slice(t,r),p=0;p<o;++p)if(c[p]!==d[p]){n=c[p],a=d[p];break}return n<a?-1:a<n?1:0},ie.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},ie.prototype.indexOf=function(e,t,r){return me(this,e,t,r,!0)},ie.prototype.lastIndexOf=function(e,t,r){return me(this,e,t,r,!1)},ie.prototype.write=function(e,t,r,s){if(void 0===t)s="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)s=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===s&&(s="utf8")):(s=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var n=!1;;)switch(s){case"hex":return ge(this,e,t,r);case"utf8":case"utf-8":return ye(this,e,t,r);case"ascii":return _e(this,e,t,r);case"latin1":case"binary":return be(this,e,t,r);case"base64":return ve(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return we(this,e,t,r);default:if(n)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),n=!0}},ie.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Pe=4096;function Te(e,t,r){var s="";r=Math.min(e.length,r);for(var i=t;i<r;++i)s+=String.fromCharCode(127&e[i]);return s}function Ce(e,t,r){var s="";r=Math.min(e.length,r);for(var i=t;i<r;++i)s+=String.fromCharCode(e[i]);return s}function ke(e,t,r){var s=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>s)&&(r=s);for(var i="",n=t;n<r;++n)i+=Be(e[n]);return i}function Ee(e,t,r){for(var s=e.slice(t,r),i="",n=0;n<s.length;n+=2)i+=String.fromCharCode(s[n]+256*s[n+1]);return i}function De(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function xe(e,t,r,s,i,n){if(!pe(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<n)throw new RangeError('"value" argument is out of bounds');if(r+s>e.length)throw new RangeError("Index out of range")}function Oe(e,t,r,s){t<0&&(t=65535+t+1);for(var i=0,n=Math.min(e.length-r,2);i<n;++i)e[r+i]=(t&255<<8*(s?i:1-i))>>>8*(s?i:1-i)}function Me(e,t,r,s){t<0&&(t=4294967295+t+1);for(var i=0,n=Math.min(e.length-r,4);i<n;++i)e[r+i]=t>>>8*(s?i:3-i)&255}function Ie(e,t,r,s,i,n){if(r+s>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function je(e,t,r,s,i){return i||Ie(e,0,r,4),X(e,t,r,s,23,4),r+4}function Le(e,t,r,s,i){return i||Ie(e,0,r,8),X(e,t,r,s,52,8),r+8}ie.prototype.slice=function(e,t){var r,s=this.length;if((e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e),ie.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=ie.prototype;else{var i=t-e;r=new ie(i,void 0);for(var n=0;n<i;++n)r[n]=this[n+e]}return r},ie.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||De(e,t,this.length);for(var s=this[e],i=1,n=0;++n<t&&(i*=256);)s+=this[e+n]*i;return s},ie.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||De(e,t,this.length);for(var s=this[e+--t],i=1;t>0&&(i*=256);)s+=this[e+--t]*i;return s},ie.prototype.readUInt8=function(e,t){return t||De(e,1,this.length),this[e]},ie.prototype.readUInt16LE=function(e,t){return t||De(e,2,this.length),this[e]|this[e+1]<<8},ie.prototype.readUInt16BE=function(e,t){return t||De(e,2,this.length),this[e]<<8|this[e+1]},ie.prototype.readUInt32LE=function(e,t){return t||De(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},ie.prototype.readUInt32BE=function(e,t){return t||De(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},ie.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||De(e,t,this.length);for(var s=this[e],i=1,n=0;++n<t&&(i*=256);)s+=this[e+n]*i;return s>=(i*=128)&&(s-=Math.pow(2,8*t)),s},ie.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||De(e,t,this.length);for(var s=t,i=1,n=this[e+--s];s>0&&(i*=256);)n+=this[e+--s]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},ie.prototype.readInt8=function(e,t){return t||De(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},ie.prototype.readInt16LE=function(e,t){t||De(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},ie.prototype.readInt16BE=function(e,t){t||De(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},ie.prototype.readInt32LE=function(e,t){return t||De(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},ie.prototype.readInt32BE=function(e,t){return t||De(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},ie.prototype.readFloatLE=function(e,t){return t||De(e,4,this.length),Z(this,e,!0,23,4)},ie.prototype.readFloatBE=function(e,t){return t||De(e,4,this.length),Z(this,e,!1,23,4)},ie.prototype.readDoubleLE=function(e,t){return t||De(e,8,this.length),Z(this,e,!0,52,8)},ie.prototype.readDoubleBE=function(e,t){return t||De(e,8,this.length),Z(this,e,!1,52,8)},ie.prototype.writeUIntLE=function(e,t,r,s){(e=+e,t|=0,r|=0,s)||xe(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,n=0;for(this[t]=255&e;++n<r&&(i*=256);)this[t+n]=e/i&255;return t+r},ie.prototype.writeUIntBE=function(e,t,r,s){(e=+e,t|=0,r|=0,s)||xe(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,n=1;for(this[t+i]=255&e;--i>=0&&(n*=256);)this[t+i]=e/n&255;return t+r},ie.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,1,255,0),ie.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},ie.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,2,65535,0),ie.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Oe(this,e,t,!0),t+2},ie.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,2,65535,0),ie.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Oe(this,e,t,!1),t+2},ie.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,4,4294967295,0),ie.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):Me(this,e,t,!0),t+4},ie.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,4,4294967295,0),ie.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ie.prototype.writeIntLE=function(e,t,r,s){if(e=+e,t|=0,!s){var i=Math.pow(2,8*r-1);xe(this,e,t,r,i-1,-i)}var n=0,a=1,o=0;for(this[t]=255&e;++n<r&&(a*=256);)e<0&&0===o&&0!==this[t+n-1]&&(o=1),this[t+n]=(e/a>>0)-o&255;return t+r},ie.prototype.writeIntBE=function(e,t,r,s){if(e=+e,t|=0,!s){var i=Math.pow(2,8*r-1);xe(this,e,t,r,i-1,-i)}var n=r-1,a=1,o=0;for(this[t+n]=255&e;--n>=0&&(a*=256);)e<0&&0===o&&0!==this[t+n+1]&&(o=1),this[t+n]=(e/a>>0)-o&255;return t+r},ie.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,1,127,-128),ie.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},ie.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,2,32767,-32768),ie.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Oe(this,e,t,!0),t+2},ie.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,2,32767,-32768),ie.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Oe(this,e,t,!1),t+2},ie.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,4,2147483647,-2147483648),ie.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):Me(this,e,t,!0),t+4},ie.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||xe(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),ie.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ie.prototype.writeFloatLE=function(e,t,r){return je(this,e,t,!0,r)},ie.prototype.writeFloatBE=function(e,t,r){return je(this,e,t,!1,r)},ie.prototype.writeDoubleLE=function(e,t,r){return Le(this,e,t,!0,r)},ie.prototype.writeDoubleBE=function(e,t,r){return Le(this,e,t,!1,r)},ie.prototype.copy=function(e,t,r,s){if(r||(r=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<r&&(s=r),s===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-r&&(s=e.length-t+r);var i,n=s-r;if(this===e&&r<t&&t<s)for(i=n-1;i>=0;--i)e[i+t]=this[i+r];else if(n<1e3||!ie.TYPED_ARRAY_SUPPORT)for(i=0;i<n;++i)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+n),t);return n},ie.prototype.fill=function(e,t,r,s){if("string"==typeof e){if("string"==typeof t?(s=t,t=0,r=this.length):"string"==typeof r&&(s=r,r=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!ie.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var n;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(n=t;n<r;++n)this[n]=e;else{var a=pe(e)?e:Fe(new ie(e,s).toString()),o=a.length;for(n=0;n<r-t;++n)this[n+t]=a[n%o]}return this};var Ae=/[^+\/0-9A-Za-z-_]/g;function Be(e){return e<16?"0"+e.toString(16):e.toString(16)}function Fe(e,t){var r;t=t||1/0;for(var s=e.length,i=null,n=[],a=0;a<s;++a){if((r=e.charCodeAt(a))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(a+1===s){(t-=3)>-1&&n.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&n.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&n.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;n.push(r)}else if(r<2048){if((t-=2)<0)break;n.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;n.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return n}function Ne(e){return function(e){var t,r,s,i,n,a;K||Y();var o=e.length;if(o%4>0)throw new Error("Invalid string. Length must be a multiple of 4");n="="===e[o-2]?2:"="===e[o-1]?1:0,a=new W(3*o/4-n),s=n>0?o-4:o;var c=0;for(t=0,r=0;t<s;t+=4,r+=3)i=H[e.charCodeAt(t)]<<18|H[e.charCodeAt(t+1)]<<12|H[e.charCodeAt(t+2)]<<6|H[e.charCodeAt(t+3)],a[c++]=i>>16&255,a[c++]=i>>8&255,a[c++]=255&i;return 2===n?(i=H[e.charCodeAt(t)]<<2|H[e.charCodeAt(t+1)]>>4,a[c++]=255&i):1===n&&(i=H[e.charCodeAt(t)]<<10|H[e.charCodeAt(t+1)]<<4|H[e.charCodeAt(t+2)]>>2,a[c++]=i>>8&255,a[c++]=255&i),a}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Ae,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Ue(e,t,r,s){for(var i=0;i<s&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function ze(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}var $e="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e},Ve=/%[sdj%]/g;function qe(e){if(!at(e)){for(var t=[],r=0;r<arguments.length;r++)t.push(Ye(arguments[r]));return t.join(" ")}r=1;for(var s=arguments,i=s.length,n=String(e).replace(Ve,(function(e){if("%%"===e)return"%";if(r>=i)return e;switch(e){case"%s":return String(s[r++]);case"%d":return Number(s[r++]);case"%j":try{return JSON.stringify(s[r++])}catch(e){return"[Circular]"}default:return e}})),a=s[r];r<i;a=s[++r])st(a)||!pt(a)?n+=" "+a:n+=" "+Ye(a);return n}function Ge(e,r){if(ct(t.process))return function(){return Ge(e,r).apply(this,arguments)};var s=!1;return function(){return s||(console.error(r),s=!0),e.apply(this,arguments)}}var He,We={};function Ke(e){if(ct(He)&&(He=T.env.NODE_DEBUG||""),e=e.toUpperCase(),!We[e])if(new RegExp("\\b"+e+"\\b","i").test(He)){We[e]=function(){var t=qe.apply(null,arguments);console.error("%s %d: %s",e,0,t)}}else We[e]=function(){};return We[e]}function Ye(e,t){var r={seen:[],stylize:Je};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),rt(t)?r.showHidden=t:t&&wt(r,t),ct(r.showHidden)&&(r.showHidden=!1),ct(r.depth)&&(r.depth=2),ct(r.colors)&&(r.colors=!1),ct(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=Qe),Ze(r,e,r.depth)}function Qe(e,t){var r=Ye.styles[t];return r?"["+Ye.colors[r][0]+"m"+e+"["+Ye.colors[r][1]+"m":e}function Je(e,t){return e}function Ze(e,t,r){if(e.customInspect&&t&&ut(t.inspect)&&t.inspect!==Ye&&(!t.constructor||t.constructor.prototype!==t)){var s=t.inspect(r,e);return at(s)||(s=Ze(e,s,r)),s}var i=function(e,t){if(ct(t))return e.stylize("undefined","undefined");if(at(t)){var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string")}if(nt(t))return e.stylize(""+t,"number");if(rt(t))return e.stylize(""+t,"boolean");if(st(t))return e.stylize("null","null")}(e,t);if(i)return i;var n=Object.keys(t),a=function(e){var t={};return e.forEach((function(e,r){t[e]=!0})),t}(n);if(e.showHidden&&(n=Object.getOwnPropertyNames(t)),ht(t)&&(n.indexOf("message")>=0||n.indexOf("description")>=0))return Xe(t);if(0===n.length){if(ut(t)){var o=t.name?": "+t.name:"";return e.stylize("[Function"+o+"]","special")}if(dt(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(lt(t))return e.stylize(Date.prototype.toString.call(t),"date");if(ht(t))return Xe(t)}var c,d="",p=!1,l=["{","}"];(tt(t)&&(p=!0,l=["[","]"]),ut(t))&&(d=" [Function"+(t.name?": "+t.name:"")+"]");return dt(t)&&(d=" "+RegExp.prototype.toString.call(t)),lt(t)&&(d=" "+Date.prototype.toUTCString.call(t)),ht(t)&&(d=" "+Xe(t)),0!==n.length||p&&0!=t.length?r<0?dt(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),c=p?function(e,t,r,s,i){for(var n=[],a=0,o=t.length;a<o;++a)St(t,String(a))?n.push(et(e,t,r,s,String(a),!0)):n.push("");return i.forEach((function(i){i.match(/^\d+$/)||n.push(et(e,t,r,s,i,!0))})),n}(e,t,r,a,n):n.map((function(s){return et(e,t,r,a,s,p)})),e.seen.pop(),function(e,t,r){if(e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1];return r[0]+t+" "+e.join(", ")+" "+r[1]}(c,d,l)):l[0]+d+l[1]}function Xe(e){return"["+Error.prototype.toString.call(e)+"]"}function et(e,t,r,s,i,n){var a,o,c;if((c=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?o=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(o=e.stylize("[Setter]","special")),St(s,i)||(a="["+i+"]"),o||(e.seen.indexOf(c.value)<0?(o=st(r)?Ze(e,c.value,null):Ze(e,c.value,r-1)).indexOf("\n")>-1&&(o=n?o.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+o.split("\n").map((function(e){return"   "+e})).join("\n")):o=e.stylize("[Circular]","special")),ct(a)){if(n&&i.match(/^\d+$/))return o;(a=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+o}function tt(e){return Array.isArray(e)}function rt(e){return"boolean"==typeof e}function st(e){return null===e}function it(e){return null==e}function nt(e){return"number"==typeof e}function at(e){return"string"==typeof e}function ot(e){return"symbol"==typeof e}function ct(e){return void 0===e}function dt(e){return pt(e)&&"[object RegExp]"===gt(e)}function pt(e){return"object"==typeof e&&null!==e}function lt(e){return pt(e)&&"[object Date]"===gt(e)}function ht(e){return pt(e)&&("[object Error]"===gt(e)||e instanceof Error)}function ut(e){return"function"==typeof e}function mt(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function ft(e){return ie.isBuffer(e)}function gt(e){return Object.prototype.toString.call(e)}function yt(e){return e<10?"0"+e.toString(10):e.toString(10)}Ye.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},Ye.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var _t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function bt(){var e=new Date,t=[yt(e.getHours()),yt(e.getMinutes()),yt(e.getSeconds())].join(":");return[e.getDate(),_t[e.getMonth()],t].join(" ")}function vt(){console.log("%s - %s",bt(),qe.apply(null,arguments))}function wt(e,t){if(!t||!pt(t))return e;for(var r=Object.keys(t),s=r.length;s--;)e[r[s]]=t[r[s]];return e}function St(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var Rt={inherits:$e,_extend:wt,log:vt,isBuffer:ft,isPrimitive:mt,isFunction:ut,isError:ht,isDate:lt,isObject:pt,isRegExp:dt,isUndefined:ct,isSymbol:ot,isString:at,isNumber:nt,isNullOrUndefined:it,isNull:st,isBoolean:rt,isArray:tt,inspect:Ye,deprecate:Ge,format:qe,debuglog:Ke},Pt=k(Object.freeze({__proto__:null,format:qe,deprecate:Ge,debuglog:Ke,inspect:Ye,isArray:tt,isBoolean:rt,isNull:st,isNullOrUndefined:it,isNumber:nt,isString:at,isSymbol:ot,isUndefined:ct,isRegExp:dt,isObject:pt,isDate:lt,isError:ht,isFunction:ut,isPrimitive:mt,isBuffer:ft,log:vt,inherits:$e,_extend:wt,default:Rt}));const Tt=function(){const e=/(Chrome|Chromium)\/(?<chromeVersion>\d+)\./.exec(navigator.userAgent);if(e)return Number.parseInt(e.groups.chromeVersion,10)}()>=69&&{level:1,hasBasic:!0,has256:!1,has16m:!1};var Ct={stdout:Tt,stderr:Tt};!function(e,t){const r=q,s=Pt;t.init=function(e){e.inspectOpts={};const r=Object.keys(t.inspectOpts);for(let s=0;s<r.length;s++)e.inspectOpts[r[s]]=t.inspectOpts[r[s]]},t.log=function(...e){return T.stderr.write(s.format(...e)+"\n")},t.formatArgs=function(r){const{namespace:s,useColors:i}=this;if(i){const t=this.color,i="[3"+(t<8?t:"8;5;"+t),n=`  ${i};1m${s} [0m`;r[0]=n+r[0].split("\n").join("\n"+n),r.push(i+"m+"+e.exports.humanize(this.diff)+"[0m")}else r[0]=function(){if(t.inspectOpts.hideDate)return"";return(new Date).toISOString()+" "}()+s+" "+r[0]},t.save=function(e){e?T.env.DEBUG=e:delete T.env.DEBUG},t.load=function(){return T.env.DEBUG},t.useColors=function(){return"colors"in t.inspectOpts?Boolean(t.inspectOpts.colors):r.isatty(T.stderr.fd)},t.destroy=s.deprecate((()=>{}),"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."),t.colors=[6,2,3,4,5,1];try{const e=Ct;e&&(e.stderr||e).level>=2&&(t.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(e){}t.inspectOpts=Object.keys(T.env).filter((e=>/^debug_/i.test(e))).reduce(((e,t)=>{const r=t.substring(6).toLowerCase().replace(/_([a-z])/g,((e,t)=>t.toUpperCase()));let s=T.env[t];return s=!!/^(yes|on|true|enabled)$/i.test(s)||!/^(no|off|false|disabled)$/i.test(s)&&("null"===s?null:Number(s)),e[r]=s,e}),{}),e.exports=F(t);const{formatters:i}=e.exports;i.o=function(e){return this.inspectOpts.colors=this.useColors,s.inspect(e,this.inspectOpts).split("\n").map((e=>e.trim())).join(" ")},i.O=function(e){return this.inspectOpts.colors=this.useColors,s.inspect(e,this.inspectOpts)}}(N,N.exports),void 0===T||"renderer"===T.type||!0===T.browser||T.__nwjs?E.exports=D.exports:E.exports=N.exports;var kt=E.exports;const Et="mrtc-web-sdk";class Dt{constructor(e){this.debug=kt(`${Et}:${e}`),this.warn=kt(`${Et}:${e}`),this.error=kt(`${Et}:${e}`),this.debug.log=console.log.bind(console),this.warn.log=console.warn.bind(console),this.error.log=console.error.bind(console)}}new Dt("Stream");class xt{createCameraAndMicTracks(e,t){const r=Mt(e),s=It(t);return navigator.mediaDevices.getUserMedia({video:r,audio:s}).then((e=>{const t=e.getVideoTracks()[0],r=e.getAudioTracks()[0];return Promise.resolve([t,r])}))}createScreenTracks(e=!0){return navigator.mediaDevices.getDisplayMedia({video:!0,audio:e}).then((e=>{const t=e.getVideoTracks()[0],r=e.getAudioTracks()[0];return Promise.resolve([t,r])}))}createCameraTrack(e){const t=Mt(e);return navigator.mediaDevices.getUserMedia({video:t,audio:!1}).then((e=>Promise.resolve(e.getVideoTracks()[0])))}createMicTrack(e){const t=It(e);return navigator.mediaDevices.getUserMedia({video:!1,audio:t}).then((e=>Promise.resolve(e.getAudioTracks()[0])))}createVideoElementTracks(e){const t=Ot(e);return[t.getVideoTracks()[0],t.getAudioTracks()[0]]}createAudioElementTrack(e){return Ot(e).getAudioTracks()[0]}createCanvasTrack(e,t){return Ot(e,t).getVideoTracks()[0]}createEmptyAudioTrack(){return(new AudioContext).createMediaStreamDestination().stream.getAudioTracks()[0]}createEmptyVideoTrack(e=1280,t=720,r="#000000"){const s=document.createElement("canvas"),i=s.getContext("2d");s.width=e,s.height=t;const n=Ot(s);return setInterval((()=>{i&&(i.fillStyle=r),i&&i.fillRect(0,0,e,t)}),1e3),n.getVideoTracks()[0].clone()}mixAudioTracks(e){const t=new AudioContext,r=t.createDynamicsCompressor(),s=t.createMediaStreamDestination();e.forEach((e=>{t.createMediaStreamSource(new MediaStream([e])).connect(r)})),r.connect(s);return s.stream.getAudioTracks()[0]}}function Ot(e,t){return e.captureStream?e.captureStream(t):e.mozCaptureStream(t)}function Mt(e={}){const{deviceId:t,aspectRatio:r,facingMode:s,frameRate:i,width:n,height:a}=e;return{deviceId:t,aspectRatio:r,facingMode:s,frameRate:i,width:n,height:a}}function It(e={}){const{deviceId:t,AEC:r,AGC:s,ANS:i,sampleRate:n,sampleSize:a,volume:o}=e;return{deviceId:t,autoGainControl:s,echoCancellation:r,noiseSuppression:i,sampleRate:n,sampleSize:a,volume:o}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function jt(e,t,r,s){return new(r||(r=Promise))((function(i,n){function a(e){try{c(s.next(e))}catch(e){n(e)}}function o(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))}var Lt={exports:{}};function At(e){var t,r;const s=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),i=e.match(s);return{protocol:i[2],host:i[4],app:null===(t=i[5])||void 0===t?void 0:t.replace(/^\//,"").split("/")[0],streamId:null===(r=i[5])||void 0===r?void 0:r.replace(/^\//,"").split("/")[1]}}function Bt(e){return e instanceof MediaStreamTrack}function Ft(e){return JSON.stringify(e,(()=>{const e=new WeakSet;return(t,r)=>{if("object"==typeof r&&null!==r){if(e.has(r))return;e.add(r)}return r}})())}function Nt(e){return t=>{const r=Object.prototype.toString.call(t);return`[object ${e.toLowerCase()}]`===r.toLowerCase()}}!function(e,t){!function(e){var t="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==t&&t,r={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};function s(e){return e&&DataView.prototype.isPrototypeOf(e)}if(r.arrayBuffer)var i=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],n=ArrayBuffer.isView||function(e){return e&&i.indexOf(Object.prototype.toString.call(e))>-1};function a(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function o(e){return"string"!=typeof e&&(e=String(e)),e}function c(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return r.iterable&&(t[Symbol.iterator]=function(){return t}),t}function d(e){this.map={},e instanceof d?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function p(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function l(e){return new Promise((function(t,r){e.onload=function(){t(e.result)},e.onerror=function(){r(e.error)}}))}function h(e){var t=new FileReader,r=l(t);return t.readAsArrayBuffer(e),r}function u(e){var t=new FileReader,r=l(t);return t.readAsText(e),r}function m(e){for(var t=new Uint8Array(e),r=new Array(t.length),s=0;s<t.length;s++)r[s]=String.fromCharCode(t[s]);return r.join("")}function f(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function g(){return this.bodyUsed=!1,this._initBody=function(e){this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:r.blob&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:r.formData&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:r.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():r.arrayBuffer&&r.blob&&s(e)?(this._bodyArrayBuffer=f(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):r.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(e)||n(e))?this._bodyArrayBuffer=f(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):r.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},r.blob&&(this.blob=function(){var e=p(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=p(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}return this.blob().then(h)}),this.text=function(){var e=p(this);if(e)return e;if(this._bodyBlob)return u(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(m(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},r.formData&&(this.formData=function(){return this.text().then(v)}),this.json=function(){return this.text().then(JSON.parse)},this}d.prototype.append=function(e,t){e=a(e),t=o(t);var r=this.map[e];this.map[e]=r?r+", "+t:t},d.prototype.delete=function(e){delete this.map[a(e)]},d.prototype.get=function(e){return e=a(e),this.has(e)?this.map[e]:null},d.prototype.has=function(e){return this.map.hasOwnProperty(a(e))},d.prototype.set=function(e,t){this.map[a(e)]=o(t)},d.prototype.forEach=function(e,t){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(t,this.map[r],r,this)},d.prototype.keys=function(){var e=[];return this.forEach((function(t,r){e.push(r)})),c(e)},d.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),c(e)},d.prototype.entries=function(){var e=[];return this.forEach((function(t,r){e.push([r,t])})),c(e)},r.iterable&&(d.prototype[Symbol.iterator]=d.prototype.entries);var y=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function _(e){var t=e.toUpperCase();return y.indexOf(t)>-1?t:e}function b(e,t){if(!(this instanceof b))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var r=(t=t||{}).body;if(e instanceof b){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new d(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,r||null==e._bodyInit||(r=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new d(t.headers)),this.method=_(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&r)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(r),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var s=/([?&])_=[^&]*/;if(s.test(this.url))this.url=this.url.replace(s,"$1_="+(new Date).getTime());else{var i=/\?/;this.url+=(i.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function v(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var r=e.split("="),s=r.shift().replace(/\+/g," "),i=r.join("=").replace(/\+/g," ");t.append(decodeURIComponent(s),decodeURIComponent(i))}})),t}function w(e){var t=new d;return e.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e})).forEach((function(e){var r=e.split(":"),s=r.shift().trim();if(s){var i=r.join(":").trim();t.append(s,i)}})),t}function S(e,t){if(!(this instanceof S))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new d(t.headers),this.url=t.url||"",this._initBody(e)}b.prototype.clone=function(){return new b(this,{body:this._bodyInit})},g.call(b.prototype),g.call(S.prototype),S.prototype.clone=function(){return new S(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new d(this.headers),url:this.url})},S.error=function(){var e=new S(null,{status:0,statusText:""});return e.type="error",e};var R=[301,302,303,307,308];S.redirect=function(e,t){if(-1===R.indexOf(t))throw new RangeError("Invalid status code");return new S(null,{status:t,headers:{location:e}})},e.DOMException=t.DOMException;try{new e.DOMException}catch(t){e.DOMException=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function P(s,i){return new Promise((function(n,a){var c=new b(s,i);if(c.signal&&c.signal.aborted)return a(new e.DOMException("Aborted","AbortError"));var p=new XMLHttpRequest;function l(){p.abort()}function h(e){try{return""===e&&t.location.href?t.location.href:e}catch(t){return e}}p.onload=function(){var e={status:p.status,statusText:p.statusText,headers:w(p.getAllResponseHeaders()||"")};e.url="responseURL"in p?p.responseURL:e.headers.get("X-Request-URL");var t="response"in p?p.response:p.responseText;setTimeout((function(){n(new S(t,e))}),0)},p.onerror=function(){setTimeout((function(){a(new TypeError("Network request failed"))}),0)},p.ontimeout=function(){setTimeout((function(){a(new TypeError("Network request failed"))}),0)},p.onabort=function(){setTimeout((function(){a(new e.DOMException("Aborted","AbortError"))}),0)},p.open(c.method,h(c.url),!0),"include"===c.credentials?p.withCredentials=!0:"omit"===c.credentials&&(p.withCredentials=!1),"responseType"in p&&(r.blob?p.responseType="blob":r.arrayBuffer&&c.headers.get("Content-Type")&&-1!==c.headers.get("Content-Type").indexOf("application/octet-stream")&&(p.responseType="arraybuffer")),!i||"object"!=typeof i.headers||i.headers instanceof d?c.headers.forEach((function(e,t){p.setRequestHeader(t,e)})):Object.getOwnPropertyNames(i.headers).forEach((function(e){p.setRequestHeader(e,o(i.headers[e]))})),c.signal&&(c.signal.addEventListener("abort",l),p.onreadystatechange=function(){4===p.readyState&&c.signal.removeEventListener("abort",l)}),p.send(void 0===c._bodyInit?null:c._bodyInit)}))}P.polyfill=!0,t.fetch||(t.fetch=P,t.Headers=d,t.Request=b,t.Response=S),e.Headers=d,e.Request=b,e.Response=S,e.fetch=P,Object.defineProperty(e,"__esModule",{value:!0})}(t)}(0,Lt.exports);const Ut=e=>Nt("object")(e),zt=1e7,$t=(e,t="")=>((e,t,r)=>{const s=process.env[e];return void 0===s?t:r(s)})(e,t,(e=>e));function Vt({appId:e,nonce:t,timestamp:r,signature:s,mrtcUrl:i,userId:n,operateType:a}){const o=$t("MRTC_MEDIA_SERVER_PUBLISH_HOST"),c=$t("MRTC_PUBLISH_STREAM_ID"),d=$t("MRTC_PUBLISH_USER_TOKEN"),p=$t("MRTC_MEDIA_SERVER_SUBSCRIBE_HOST"),l=$t("MRTC_SUBSCRIBE_STREAM_ID"),h=$t("MRTC_SUBSCRIBE_USER_TOKEN");if("push"===a&&o&&c&&d)return Promise.resolve({host:o,streamId:c,token:d});if("pull"===a&&p&&l&&h)return Promise.resolve({host:p,streamId:l,token:h});const{host:u,streamId:m}=At(i);return window.fetch(`https://${u}/api/v1/mdc-rtc-manager/endpoint/authorization`,{method:"POST",headers:{"Content-Type":"application/json","x-ca-key":e,"x-ca-nonce":t,"x-ca-timestamp":String(r),"x-ca-signature":s,"x-ca-signature-method":"HmacSHA256"},body:JSON.stringify({userId:n,streamId:m,userType:"web",operateType:a})}).then((e=>e.json())).then((e=>new Promise(((t,r)=>{if(e.code===zt){const{mrtcUrl:r,token:s}=e.data,{host:i,streamId:n}=At(r);t({host:i,streamId:n,token:s})}else r(e)}))))}var qt={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function s(){}function i(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function n(e,t,s,n,a){if("function"!=typeof s)throw new TypeError("The listener must be a function");var o=new i(s,n||e,a),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function o(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,s,i=[];if(0===this._eventsCount)return i;for(s in e=this._events)t.call(e,s)&&i.push(r?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=r?r+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,n=s.length,a=new Array(n);i<n;i++)a[i]=s[i].fn;return a},o.prototype.listenerCount=function(e){var t=r?r+e:e,s=this._events[t];return s?s.fn?1:s.length:0},o.prototype.emit=function(e,t,s,i,n,a){var o=r?r+e:e;if(!this._events[o])return!1;var c,d,p=this._events[o],l=arguments.length;if(p.fn){switch(p.once&&this.removeListener(e,p.fn,void 0,!0),l){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,t),!0;case 3:return p.fn.call(p.context,t,s),!0;case 4:return p.fn.call(p.context,t,s,i),!0;case 5:return p.fn.call(p.context,t,s,i,n),!0;case 6:return p.fn.call(p.context,t,s,i,n,a),!0}for(d=1,c=new Array(l-1);d<l;d++)c[d-1]=arguments[d];p.fn.apply(p.context,c)}else{var h,u=p.length;for(d=0;d<u;d++)switch(p[d].once&&this.removeListener(e,p[d].fn,void 0,!0),l){case 1:p[d].fn.call(p[d].context);break;case 2:p[d].fn.call(p[d].context,t);break;case 3:p[d].fn.call(p[d].context,t,s);break;case 4:p[d].fn.call(p[d].context,t,s,i);break;default:if(!c)for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];p[d].fn.apply(p[d].context,c)}}return!0},o.prototype.on=function(e,t,r){return n(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return n(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,s,i){var n=r?r+e:e;if(!this._events[n])return this;if(!t)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||i&&!o.once||s&&o.context!==s||a(this,n);else{for(var c=0,d=[],p=o.length;c<p;c++)(o[c].fn!==t||i&&!o[c].once||s&&o[c].context!==s)&&d.push(o[c]);d.length?this._events[n]=1===d.length?d[0]:d:a(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&a(this,t)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o}(qt);var Gt=qt.exports;const Ht={code:1003,message:"track is invalid"},Wt={code:1004,message:"operation is invalid"},Kt={code:1006,message:"cannot produce video"},Yt={code:1007,message:"already publish"},Qt={code:1008,message:"not publish"},Jt={code:1009,message:"already subscribe"},Zt={code:1010,message:"not subscribe"},Xt={code:1011,message:"get stats error"},er={code:1012,message:"not publish or not subscribe"},tr={code:1013,message:"custom message is invalid"};class rr{getTransportStats(e,t){return jt(this,void 0,void 0,(function*(){const{RTT:r,bytes:s,bitrate:i}=yield this.getTransportStatsByTransport(e,"bytesSent"),{RTT:n,bytes:a,bitrate:o}=yield this.getTransportStatsByTransport(t,"bytesReceived");return{RTT:1e3*Math.max(r,n),receiveBitrate:o,bytesReceived:a,sendBitrate:i,bytesSent:s}}))}getProducerAudioStats(e){return jt(this,void 0,void 0,(function*(){const t=yield this.getBitrateByReport(e,"outbound-rtp","bytesSent"),r=this.getStatsByReport(yield e.getStats()),{"outbound-rtp":{bytesSent:s,packetsSent:i},"remote-inbound-rtp":{packetsLost:n},codec:{mimeType:a}}=r;return{codecType:a.split("/")[1],sendBitrate:t,bytesSent:s,packetsSent:i,packetsLost:n}}))}getProducerVideoStats(e){return jt(this,void 0,void 0,(function*(){const t=yield this.getBitrateByReport(e,"outbound-rtp","bytesSent"),r=this.getStatsByReport(yield e.getStats()),{"media-source":{framesPerSecond:s,width:i,height:n},"outbound-rtp":{bytesSent:a,packetsSent:o,framesPerSecond:c,frameWidth:d,frameHeight:p},"remote-inbound-rtp":{packetsLost:l},codec:{mimeType:h}}=r;return{codecType:h.split("/")[1],captureFrameRate:s,captureWidth:i,captureHeight:n,sendBitrate:t,bytesSent:a,sendFrameRate:c,packetsSent:o,packetsLost:l,sendWidth:d,sendHeight:p}}))}getConsumerAudioStats(e){return jt(this,void 0,void 0,(function*(){const t=yield this.getBitrateByReport(e,"inbound-rtp","bytesReceived"),r=this.getStatsByReport(yield e.getStats()),{"inbound-rtp":{bytesReceived:s,packetsReceived:i,packetsLost:n,totalSamplesDuration:a},codec:{mimeType:o}}=r;return{codecType:o.split("/")[1],packetLossRate:n/i,receiveBitrate:t,bytesReceived:s,packetsReceived:i,packetsLost:n,totalSamplesDuration:a}}))}getConsumerVideoStats(e){return jt(this,void 0,void 0,(function*(){const t=yield this.getBitrateByReport(e,"inbound-rtp","bytesReceived"),r=this.getStatsByReport(yield e.getStats()),{"inbound-rtp":{packetsLost:s,packetsReceived:i,bytesReceived:n,framesPerSecond:a,frameWidth:o,frameHeight:c},codec:{mimeType:d}}=r;return{codecType:d.split("/")[1],packetLossRate:s/i,receiveBitrate:t,bytesReceived:n,receiveFrameRate:a,packetsReceived:i,packetsLost:s,receiveWidth:o,receiveHeight:c}}))}getStatsByReport(e){const t={};return e.forEach((e=>{t[e.type]=e})),t}getBitrateByReport(e,t,r){return jt(this,void 0,void 0,(function*(){const s=this.getStatsByReport(yield e.getStats());var i;yield(i=100,new Promise((e=>setTimeout(e,i))));const n=this.getStatsByReport(yield e.getStats()),{[r]:a,timestamp:o}=s[t],{[r]:c,timestamp:d}=n[t];return Math.floor((c-a)/((d-o)/1e3)*8)}))}getTransportStatsByTransport(e,t){return jt(this,void 0,void 0,(function*(){if(e){const r=this.getStatsByReport(yield e.getStats()),{"candidate-pair":{currentRoundTripTime:s=-.001},transport:{[t]:i}}=r;return{RTT:s,bytes:i,bitrate:yield this.getBitrateByReport(e,"transport",t)}}return{RTT:-1,bytes:0,bitrate:0}}))}}var sr={},ir={};const nr={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},ar={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},or={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},cr={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},dr={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};class pr{static getFirstMatch(e,t){const r=t.match(e);return r&&r.length>0&&r[1]||""}static getSecondMatch(e,t){const r=t.match(e);return r&&r.length>1&&r[2]||""}static matchAndReturnConst(e,t,r){if(e.test(t))return r}static getWindowsVersionName(e){switch(e){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}static getMacOSVersionName(e){const t=e.split(".").splice(0,2).map((e=>parseInt(e,10)||0));if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}}static getAndroidVersionName(e){const t=e.split(".").splice(0,2).map((e=>parseInt(e,10)||0));if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0}static getVersionPrecision(e){return e.split(".").length}static compareVersions(e,t,r=!1){const s=pr.getVersionPrecision(e),i=pr.getVersionPrecision(t);let n=Math.max(s,i),a=0;const o=pr.map([e,t],(e=>{const t=n-pr.getVersionPrecision(e),r=e+new Array(t+1).join(".0");return pr.map(r.split("."),(e=>new Array(20-e.length).join("0")+e)).reverse()}));for(r&&(a=n-Math.min(s,i)),n-=1;n>=a;){if(o[0][n]>o[1][n])return 1;if(o[0][n]===o[1][n]){if(n===a)return 0;n-=1}else if(o[0][n]<o[1][n])return-1}}static map(e,t){const r=[];let s;if(Array.prototype.map)return Array.prototype.map.call(e,t);for(s=0;s<e.length;s+=1)r.push(t(e[s]));return r}static find(e,t){let r,s;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(r=0,s=e.length;r<s;r+=1){const s=e[r];if(t(s,r))return s}}static assign(e,...t){const r=e;let s,i;if(Object.assign)return Object.assign(e,...t);for(s=0,i=t.length;s<i;s+=1){const e=t[s];if("object"==typeof e&&null!==e){Object.keys(e).forEach((t=>{r[t]=e[t]}))}}return e}static getBrowserAlias(e){return nr[e]}static getBrowserTypeByAlias(e){return ar[e]||""}}const lr=/version\/(\d+(\.?_?\d+)+)/i,hr=[{test:[/googlebot/i],describe(e){const t={name:"Googlebot"},r=pr.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/opera/i],describe(e){const t={name:"Opera"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/opr\/|opios/i],describe(e){const t={name:"Opera"},r=pr.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/SamsungBrowser/i],describe(e){const t={name:"Samsung Internet for Android"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Whale/i],describe(e){const t={name:"NAVER Whale Browser"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/MZBrowser/i],describe(e){const t={name:"MZ Browser"},r=pr.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/focus/i],describe(e){const t={name:"Focus"},r=pr.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/swing/i],describe(e){const t={name:"Swing"},r=pr.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/coast/i],describe(e){const t={name:"Opera Coast"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe(e){const t={name:"Opera Touch"},r=pr.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/yabrowser/i],describe(e){const t={name:"Yandex Browser"},r=pr.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/ucbrowser/i],describe(e){const t={name:"UC Browser"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Maxthon|mxios/i],describe(e){const t={name:"Maxthon"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/epiphany/i],describe(e){const t={name:"Epiphany"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/puffin/i],describe(e){const t={name:"Puffin"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sleipnir/i],describe(e){const t={name:"Sleipnir"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/k-meleon/i],describe(e){const t={name:"K-Meleon"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/micromessenger/i],describe(e){const t={name:"WeChat"},r=pr.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/qqbrowser/i],describe(e){const t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},r=pr.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/msie|trident/i],describe(e){const t={name:"Internet Explorer"},r=pr.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/\sedg\//i],describe(e){const t={name:"Microsoft Edge"},r=pr.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/edg([ea]|ios)/i],describe(e){const t={name:"Microsoft Edge"},r=pr.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/vivaldi/i],describe(e){const t={name:"Vivaldi"},r=pr.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/seamonkey/i],describe(e){const t={name:"SeaMonkey"},r=pr.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sailfish/i],describe(e){const t={name:"Sailfish"},r=pr.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return r&&(t.version=r),t}},{test:[/silk/i],describe(e){const t={name:"Amazon Silk"},r=pr.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/phantom/i],describe(e){const t={name:"PhantomJS"},r=pr.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/slimerjs/i],describe(e){const t={name:"SlimerJS"},r=pr.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(e){const t={name:"BlackBerry"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(web|hpw)[o0]s/i],describe(e){const t={name:"WebOS Browser"},r=pr.getFirstMatch(lr,e)||pr.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/bada/i],describe(e){const t={name:"Bada"},r=pr.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/tizen/i],describe(e){const t={name:"Tizen"},r=pr.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/qupzilla/i],describe(e){const t={name:"QupZilla"},r=pr.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/firefox|iceweasel|fxios/i],describe(e){const t={name:"Firefox"},r=pr.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/electron/i],describe(e){const t={name:"Electron"},r=pr.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/MiuiBrowser/i],describe(e){const t={name:"Miui"},r=pr.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/chromium/i],describe(e){const t={name:"Chromium"},r=pr.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/chrome|crios|crmo/i],describe(e){const t={name:"Chrome"},r=pr.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/GSA/i],describe(e){const t={name:"Google Search"},r=pr.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test(e){const t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe(e){const t={name:"Android Browser"},r=pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/playstation 4/i],describe(e){const t={name:"PlayStation 4"},r=pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/safari|applewebkit/i],describe(e){const t={name:"Safari"},r=pr.getFirstMatch(lr,e);return r&&(t.version=r),t}},{test:[/.*/i],describe(e){const t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:pr.getFirstMatch(t,e),version:pr.getSecondMatch(t,e)}}}];var ur=[{test:[/Roku\/DVP/],describe(e){const t=pr.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:cr.Roku,version:t}}},{test:[/windows phone/i],describe(e){const t=pr.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:cr.WindowsPhone,version:t}}},{test:[/windows /i],describe(e){const t=pr.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),r=pr.getWindowsVersionName(t);return{name:cr.Windows,version:t,versionName:r}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe(e){const t={name:cr.iOS},r=pr.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return r&&(t.version=r),t}},{test:[/macintosh/i],describe(e){const t=pr.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),r=pr.getMacOSVersionName(t),s={name:cr.MacOS,version:t};return r&&(s.versionName=r),s}},{test:[/(ipod|iphone|ipad)/i],describe(e){const t=pr.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:cr.iOS,version:t}}},{test(e){const t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe(e){const t=pr.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),r=pr.getAndroidVersionName(t),s={name:cr.Android,version:t};return r&&(s.versionName=r),s}},{test:[/(web|hpw)[o0]s/i],describe(e){const t=pr.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),r={name:cr.WebOS};return t&&t.length&&(r.version=t),r}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe(e){const t=pr.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||pr.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||pr.getFirstMatch(/\bbb(\d+)/i,e);return{name:cr.BlackBerry,version:t}}},{test:[/bada/i],describe(e){const t=pr.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:cr.Bada,version:t}}},{test:[/tizen/i],describe(e){const t=pr.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return{name:cr.Tizen,version:t}}},{test:[/linux/i],describe:()=>({name:cr.Linux})},{test:[/CrOS/],describe:()=>({name:cr.ChromeOS})},{test:[/PlayStation 4/],describe(e){const t=pr.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return{name:cr.PlayStation4,version:t}}}],mr=[{test:[/googlebot/i],describe:()=>({type:"bot",vendor:"Google"})},{test:[/huawei/i],describe(e){const t=pr.getFirstMatch(/(can-l01)/i,e)&&"Nova",r={type:or.mobile,vendor:"Huawei"};return t&&(r.model=t),r}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:()=>({type:or.tablet,vendor:"Nexus"})},{test:[/ipad/i],describe:()=>({type:or.tablet,vendor:"Apple",model:"iPad"})},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:()=>({type:or.tablet,vendor:"Apple",model:"iPad"})},{test:[/kftt build/i],describe:()=>({type:or.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"})},{test:[/silk/i],describe:()=>({type:or.tablet,vendor:"Amazon"})},{test:[/tablet(?! pc)/i],describe:()=>({type:or.tablet})},{test(e){const t=e.test(/ipod|iphone/i),r=e.test(/like (ipod|iphone)/i);return t&&!r},describe(e){const t=pr.getFirstMatch(/(ipod|iphone)/i,e);return{type:or.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:()=>({type:or.mobile,vendor:"Nexus"})},{test:[/[^-]mobi/i],describe:()=>({type:or.mobile})},{test:e=>"blackberry"===e.getBrowserName(!0),describe:()=>({type:or.mobile,vendor:"BlackBerry"})},{test:e=>"bada"===e.getBrowserName(!0),describe:()=>({type:or.mobile})},{test:e=>"windows phone"===e.getBrowserName(),describe:()=>({type:or.mobile,vendor:"Microsoft"})},{test(e){const t=Number(String(e.getOSVersion()).split(".")[0]);return"android"===e.getOSName(!0)&&t>=3},describe:()=>({type:or.tablet})},{test:e=>"android"===e.getOSName(!0),describe:()=>({type:or.mobile})},{test:e=>"macos"===e.getOSName(!0),describe:()=>({type:or.desktop,vendor:"Apple"})},{test:e=>"windows"===e.getOSName(!0),describe:()=>({type:or.desktop})},{test:e=>"linux"===e.getOSName(!0),describe:()=>({type:or.desktop})},{test:e=>"playstation 4"===e.getOSName(!0),describe:()=>({type:or.tv})},{test:e=>"roku"===e.getOSName(!0),describe:()=>({type:or.tv})}],fr=[{test:e=>"microsoft edge"===e.getBrowserName(!0),describe(e){if(/\sedg\//i.test(e))return{name:dr.Blink};const t=pr.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:dr.EdgeHTML,version:t}}},{test:[/trident/i],describe(e){const t={name:dr.Trident},r=pr.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:e=>e.test(/presto/i),describe(e){const t={name:dr.Presto},r=pr.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test(e){const t=e.test(/gecko/i),r=e.test(/like gecko/i);return t&&!r},describe(e){const t={name:dr.Gecko},r=pr.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(apple)?webkit\/537\.36/i],describe:()=>({name:dr.Blink})},{test:[/(apple)?webkit/i],describe(e){const t={name:dr.WebKit},r=pr.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}}];class gr{constructor(e,t=!1){if(null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}getUA(){return this._ua}test(e){return e.test(this._ua)}parseBrowser(){this.parsedResult.browser={};const e=pr.find(hr,(e=>{if("function"==typeof e.test)return e.test(this);if(e.test instanceof Array)return e.test.some((e=>this.test(e)));throw new Error("Browser's test function is not valid")}));return e&&(this.parsedResult.browser=e.describe(this.getUA())),this.parsedResult.browser}getBrowser(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()}getBrowserName(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""}getBrowserVersion(){return this.getBrowser().version}getOS(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()}parseOS(){this.parsedResult.os={};const e=pr.find(ur,(e=>{if("function"==typeof e.test)return e.test(this);if(e.test instanceof Array)return e.test.some((e=>this.test(e)));throw new Error("Browser's test function is not valid")}));return e&&(this.parsedResult.os=e.describe(this.getUA())),this.parsedResult.os}getOSName(e){const{name:t}=this.getOS();return e?String(t).toLowerCase()||"":t||""}getOSVersion(){return this.getOS().version}getPlatform(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()}getPlatformType(e=!1){const{type:t}=this.getPlatform();return e?String(t).toLowerCase()||"":t||""}parsePlatform(){this.parsedResult.platform={};const e=pr.find(mr,(e=>{if("function"==typeof e.test)return e.test(this);if(e.test instanceof Array)return e.test.some((e=>this.test(e)));throw new Error("Browser's test function is not valid")}));return e&&(this.parsedResult.platform=e.describe(this.getUA())),this.parsedResult.platform}getEngine(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()}getEngineName(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""}parseEngine(){this.parsedResult.engine={};const e=pr.find(fr,(e=>{if("function"==typeof e.test)return e.test(this);if(e.test instanceof Array)return e.test.some((e=>this.test(e)));throw new Error("Browser's test function is not valid")}));return e&&(this.parsedResult.engine=e.describe(this.getUA())),this.parsedResult.engine}parse(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this}getResult(){return pr.assign({},this.parsedResult)}satisfies(e){const t={};let r=0;const s={};let i=0;if(Object.keys(e).forEach((n=>{const a=e[n];"string"==typeof a?(s[n]=a,i+=1):"object"==typeof a&&(t[n]=a,r+=1)})),r>0){const e=Object.keys(t),r=pr.find(e,(e=>this.isOS(e)));if(r){const e=this.satisfies(t[r]);if(void 0!==e)return e}const s=pr.find(e,(e=>this.isPlatform(e)));if(s){const e=this.satisfies(t[s]);if(void 0!==e)return e}}if(i>0){const e=Object.keys(s),t=pr.find(e,(e=>this.isBrowser(e,!0)));if(void 0!==t)return this.compareVersion(s[t])}}isBrowser(e,t=!1){const r=this.getBrowserName().toLowerCase();let s=e.toLowerCase();const i=pr.getBrowserTypeByAlias(s);return t&&i&&(s=i.toLowerCase()),s===r}compareVersion(e){let t=[0],r=e,s=!1;const i=this.getBrowserVersion();if("string"==typeof i)return">"===e[0]||"<"===e[0]?(r=e.substr(1),"="===e[1]?(s=!0,r=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?r=e.substr(1):"~"===e[0]&&(s=!0,r=e.substr(1)),t.indexOf(pr.compareVersions(i,r,s))>-1}isOS(e){return this.getOSName(!0)===String(e).toLowerCase()}isPlatform(e){return this.getPlatformType(!0)===String(e).toLowerCase()}isEngine(e){return this.getEngineName(!0)===String(e).toLowerCase()}is(e,t=!1){return this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)}some(e=[]){return e.some((e=>this.is(e)))}}var yr=k(Object.freeze({__proto__:null,default:class{static getParser(e,t=!1){if("string"!=typeof e)throw new Error("UserAgent should be a string");return new gr(e,t)}static parse(e){return new gr(e).getResult()}static get BROWSER_MAP(){return ar}static get ENGINE_MAP(){return dr}static get OS_MAP(){return cr}static get PLATFORMS_MAP(){return or}}})),_r={},br=C&&C.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(_r,"__esModule",{value:!0}),_r.Logger=void 0;const vr=br(E.exports),wr="mediasoup-client";_r.Logger=class{constructor(e){e?(this._debug=vr.default(`${wr}:${e}`),this._warn=vr.default(`${wr}:WARN:${e}`),this._error=vr.default(`${wr}:ERROR:${e}`)):(this._debug=vr.default(wr),this._warn=vr.default(`${wr}:WARN`),this._error=vr.default(`${wr}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};var Sr,Rr={},Pr={exports:{}},Tr="object"==typeof Reflect?Reflect:null,Cr=Tr&&"function"==typeof Tr.apply?Tr.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};Sr=Tr&&"function"==typeof Tr.ownKeys?Tr.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var kr=Number.isNaN||function(e){return e!=e};function Er(){Er.init.call(this)}Pr.exports=Er,Pr.exports.once=function(e,t){return new Promise((function(r,s){function i(r){e.removeListener(t,n),s(r)}function n(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}Fr(e,t,n,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&Fr(e,"error",t,r)}(e,i,{once:!0})}))},Er.EventEmitter=Er,Er.prototype._events=void 0,Er.prototype._eventsCount=0,Er.prototype._maxListeners=void 0;var Dr=10;function xr(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function Or(e){return void 0===e._maxListeners?Er.defaultMaxListeners:e._maxListeners}function Mr(e,t,r,s){var i,n,a,o;if(xr(r),void 0===(n=e._events)?(n=e._events=Object.create(null),e._eventsCount=0):(void 0!==n.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),n=e._events),a=n[t]),void 0===a)a=n[t]=r,++e._eventsCount;else if("function"==typeof a?a=n[t]=s?[r,a]:[a,r]:s?a.unshift(r):a.push(r),(i=Or(e))>0&&a.length>i&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,o=c,console&&console.warn&&console.warn(o)}return e}function Ir(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function jr(e,t,r){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=Ir.bind(s);return i.listener=r,s.wrapFn=i,i}function Lr(e,t,r){var s=e._events;if(void 0===s)return[];var i=s[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):Br(i,i.length)}function Ar(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function Br(e,t){for(var r=new Array(t),s=0;s<t;++s)r[s]=e[s];return r}function Fr(e,t,r,s){if("function"==typeof e.on)s.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(n){s.once&&e.removeEventListener(t,i),r(n)}))}}Object.defineProperty(Er,"defaultMaxListeners",{enumerable:!0,get:function(){return Dr},set:function(e){if("number"!=typeof e||e<0||kr(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");Dr=e}}),Er.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Er.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||kr(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},Er.prototype.getMaxListeners=function(){return Or(this)},Er.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var a=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw a.context=n,a}var o=i[e];if(void 0===o)return!1;if("function"==typeof o)Cr(o,this,t);else{var c=o.length,d=Br(o,c);for(r=0;r<c;++r)Cr(d[r],this,t)}return!0},Er.prototype.addListener=function(e,t){return Mr(this,e,t,!1)},Er.prototype.on=Er.prototype.addListener,Er.prototype.prependListener=function(e,t){return Mr(this,e,t,!0)},Er.prototype.once=function(e,t){return xr(t),this.on(e,jr(this,e,t)),this},Er.prototype.prependOnceListener=function(e,t){return xr(t),this.prependListener(e,jr(this,e,t)),this},Er.prototype.removeListener=function(e,t){var r,s,i,n,a;if(xr(t),void 0===(s=this._events))return this;if(void 0===(r=s[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,n=r.length-1;n>=0;n--)if(r[n]===t||r[n].listener===t){a=r[n].listener,i=n;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(s[e]=r[0]),void 0!==s.removeListener&&this.emit("removeListener",e,a||t)}return this},Er.prototype.off=Er.prototype.removeListener,Er.prototype.removeAllListeners=function(e){var t,r,s;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,n=Object.keys(r);for(s=0;s<n.length;++s)"removeListener"!==(i=n[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},Er.prototype.listeners=function(e){return Lr(this,e,!0)},Er.prototype.rawListeners=function(e){return Lr(this,e,!1)},Er.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Ar.call(e,t)},Er.prototype.listenerCount=Ar,Er.prototype.eventNames=function(){return this._eventsCount>0?Sr(this._events):[]},Object.defineProperty(Rr,"__esModule",{value:!0}),Rr.EnhancedEventEmitter=void 0;const Nr=Pr.exports,Ur=new _r.Logger("EnhancedEventEmitter");class zr extends Nr.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const r=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return Ur.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(r)}}async safeEmitAsPromise(e,...t){return new Promise(((r,s)=>{try{this.emit(e,...t,r,s)}catch(t){Ur.error("safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,t),s(t)}}))}}Rr.EnhancedEventEmitter=zr;var $r={};Object.defineProperty($r,"__esModule",{value:!0}),$r.InvalidStateError=$r.UnsupportedError=void 0;class Vr extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Vr):this.stack=new Error(e).stack}}$r.UnsupportedError=Vr;class qr extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,qr):this.stack=new Error(e).stack}}$r.InvalidStateError=qr;var Gr={};Object.defineProperty(Gr,"__esModule",{value:!0}),Gr.generateRandomNumber=Gr.clone=void 0,Gr.clone=function(e,t){return void 0===e?t:JSON.parse(JSON.stringify(e))},Gr.generateRandomNumber=function(){return Math.round(1e7*Math.random())};var Hr={},Wr={};!function(e){const t=E.exports("h264-profile-level-id");t.log=console.info.bind(console);e.ProfileConstrainedBaseline=1,e.ProfileBaseline=2,e.ProfileMain=3,e.ProfileConstrainedHigh=4,e.ProfileHigh=5;const r=10;e.Level1_b=0,e.Level1=10,e.Level1_1=11,e.Level1_2=12,e.Level1_3=13,e.Level2=20,e.Level2_1=21,e.Level2_2=22,e.Level3=30,e.Level3_1=31,e.Level3_2=32,e.Level4=40,e.Level4_1=41,e.Level4_2=42,e.Level5=50,e.Level5_1=51,e.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t}}e.ProfileLevelId=s;const i=new s(1,31);class n{constructor(e){this._mask=~c("x",e),this._maskedValue=c("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}}class a{constructor(e,t,r){this.profile_idc=e,this.profile_iop=t,this.profile=r}}const o=[new a(66,new n("x1xx0000"),1),new a(77,new n("1xxx0000"),1),new a(88,new n("11xx0000"),1),new a(66,new n("x0xx0000"),2),new a(88,new n("10xx0000"),2),new a(77,new n("0x0x0000"),3),new a(100,new n("00000000"),5),new a(100,new n("00001100"),4)];function c(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function d(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}e.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const r=parseInt(e,16);if(0===r)return null;const i=255&r,n=r>>8&255,a=r>>16&255;let c;switch(i){case 11:c=0!=(16&n)?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:c=i;break;default:return t("parseProfileLevelId() | unrecognized level_idc:%s",i),null}for(const e of o)if(a===e.profile_idc&&e.profile_iop.isMatch(n))return new s(e.profile,c);return t("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},e.profileLevelIdToString=function(e){if(0==e.level)switch(e.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return t("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let r;switch(e.profile){case 1:r="42e0";break;case 2:r="4200";break;case 3:r="4d00";break;case 4:r="640c";break;case 5:r="6400";break;default:return t("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let s=e.level.toString(16);return 1===s.length&&(s=`0${s}`),`${r}${s}`},e.parseSdpProfileLevelId=function(t={}){const r=t["profile-level-id"];return r?e.parseProfileLevelId(r):i},e.isSameProfile=function(t={},r={}){const s=e.parseSdpProfileLevelId(t),i=e.parseSdpProfileLevelId(r);return Boolean(s&&i&&s.profile===i.profile)},e.generateProfileLevelIdForAnswer=function(i={},n={}){if(!i["profile-level-id"]&&!n["profile-level-id"])return t("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const a=e.parseSdpProfileLevelId(i),o=e.parseSdpProfileLevelId(n);if(!a)throw new TypeError("invalid local_profile_level_id");if(!o)throw new TypeError("invalid remote_profile_level_id");if(a.profile!==o.profile)throw new TypeError("H264 Profile mismatch");const c=d(i)&&d(n),p=a.level,l=o.level,h=function(e,t){return 0===e?t!==r&&0!==t:0===t?e!==r:e<t}(u=p,m=l)?u:m;var u,m;const f=c?p:h;return t("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",a.profile,f),e.profileLevelIdToString(new s(a.profile,f))}}(Wr);var Kr=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Yr=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Qr=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Kr(t,e,r);return Yr(t,e),t};Object.defineProperty(Hr,"__esModule",{value:!0}),Hr.canReceive=Hr.canSend=Hr.generateProbatorRtpParameters=Hr.reduceCodecs=Hr.getSendingRemoteRtpParameters=Hr.getSendingRtpParameters=Hr.getRecvRtpCapabilities=Hr.getExtendedRtpCapabilities=Hr.validateSctpStreamParameters=Hr.validateSctpParameters=Hr.validateNumSctpStreams=Hr.validateSctpCapabilities=Hr.validateRtcpParameters=Hr.validateRtpEncodingParameters=Hr.validateRtpHeaderExtensionParameters=Hr.validateRtpCodecParameters=Hr.validateRtpParameters=Hr.validateRtpHeaderExtension=Hr.validateRtcpFeedback=Hr.validateRtpCodecCapability=Hr.validateRtpCapabilities=void 0;const Jr=Qr(Wr),Zr=Qr(Gr);function Xr(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const r=t.exec(e.mimeType);if(!r)throw new TypeError("invalid codec.mimeType");if(e.kind=r[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError(`invalid codec parameter [key:${t}s, value:${r}]`);if("apt"===t&&"number"!=typeof r)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)es(t)}function es(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="")}function ts(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function rs(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)ss(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)is(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)ns(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),as(e.rtcp)}function ss(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const r=t.exec(e.mimeType);if(!r)throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===r[1].toLowerCase()?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError(`invalid codec parameter [key:${t}s, value:${r}]`);if("apt"===t&&"number"!=typeof r)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)es(t)}function is(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let r=e.parameters[t];if(void 0===r&&(e.parameters[t]="",r=""),"string"!=typeof r&&"number"!=typeof r)throw new TypeError("invalid header extension parameter")}}function ns(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function as(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0)}function os(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function cs(e){return!!e&&/.+\/rtx$/i.test(e.mimeType)}function ds(e,t,{strict:r=!1,modify:s=!1}={}){const i=e.mimeType.toLowerCase();if(i!==t.mimeType.toLowerCase())return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(i){case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return!1;if(r){if(!Jr.isSameProfile(e.parameters,t.parameters))return!1;let r;try{r=Jr.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(e){return!1}s&&(r?(e.parameters["profile-level-id"]=r,t.parameters["profile-level-id"]=r):(delete e.parameters["profile-level-id"],delete t.parameters["profile-level-id"]))}break;case"video/vp9":if(r){if((e.parameters["profile-id"]||0)!==(t.parameters["profile-id"]||0))return!1}}return!0}function ps(e,t){return(!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function ls(e,t){const r=[];for(const s of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find((e=>e.type===s.type&&(e.parameter===s.parameter||!e.parameter&&!s.parameter)));e&&r.push(e)}return r}Hr.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)Xr(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)ts(t)},Hr.validateRtpCodecCapability=Xr,Hr.validateRtcpFeedback=es,Hr.validateRtpHeaderExtension=ts,Hr.validateRtpParameters=rs,Hr.validateRtpCodecParameters=ss,Hr.validateRtpHeaderExtensionParameters=is,Hr.validateRtpEncodingParameters=ns,Hr.validateRtcpParameters=as,Hr.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");os(e.numStreams)},Hr.validateNumSctpStreams=os,Hr.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},Hr.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.priority&&"string"!=typeof e.priority)throw new TypeError("invalid params.priority");if(e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},Hr.getExtendedRtpCapabilities=function(e,t){const r={codecs:[],headerExtensions:[]};for(const s of t.codecs||[]){if(cs(s))continue;const t=(e.codecs||[]).find((e=>ds(e,s,{strict:!0,modify:!0})));if(!t)continue;const i={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:s.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:s.parameters,rtcpFeedback:ls(t,s)};r.codecs.push(i)}for(const s of r.codecs){const r=e.codecs.find((e=>cs(e)&&e.parameters.apt===s.localPayloadType)),i=t.codecs.find((e=>cs(e)&&e.parameters.apt===s.remotePayloadType));r&&i&&(s.localRtxPayloadType=r.preferredPayloadType,s.remoteRtxPayloadType=i.preferredPayloadType)}for(const s of t.headerExtensions){const t=e.headerExtensions.find((e=>ps(e,s)));if(!t)continue;const i={kind:s.kind,uri:s.uri,sendId:t.preferredId,recvId:s.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(s.direction){case"sendrecv":i.direction="sendrecv";break;case"recvonly":i.direction="sendonly";break;case"sendonly":i.direction="recvonly";break;case"inactive":i.direction="inactive"}r.headerExtensions.push(i)}return r},Hr.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const r of e.codecs){const e={mimeType:r.mimeType,kind:r.kind,preferredPayloadType:r.remotePayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(e),!r.remoteRtxPayloadType)continue;const s={mimeType:`${r.kind}/rtx`,kind:r.kind,preferredPayloadType:r.remoteRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.remotePayloadType},rtcpFeedback:[]};t.codecs.push(s)}for(const r of e.headerExtensions){if("sendrecv"!==r.direction&&"recvonly"!==r.direction)continue;const e={kind:r.kind,uri:r.uri,preferredId:r.recvId,preferredEncrypt:r.encrypt,direction:r.direction};t.headerExtensions.push(e)}return t},Hr.getSendingRtpParameters=function(e,t){const r={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of t.codecs){if(s.kind!==e)continue;const t={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.localParameters,rtcpFeedback:s.rtcpFeedback};if(r.codecs.push(t),s.localRtxPayloadType){const e={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};r.codecs.push(e)}}for(const s of t.headerExtensions){if(s.kind&&s.kind!==e||"sendrecv"!==s.direction&&"sendonly"!==s.direction)continue;const t={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};r.headerExtensions.push(t)}return r},Hr.getSendingRemoteRtpParameters=function(e,t){const r={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const s of t.codecs){if(s.kind!==e)continue;const t={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.remoteParameters,rtcpFeedback:s.rtcpFeedback};if(r.codecs.push(t),s.localRtxPayloadType){const e={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};r.codecs.push(e)}}for(const s of t.headerExtensions){if(s.kind&&s.kind!==e||"sendrecv"!==s.direction&&"sendonly"!==s.direction)continue;const t={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};r.headerExtensions.push(t)}if(r.headerExtensions.some((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri)))for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"goog-remb"!==e.type));else if(r.headerExtensions.some((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri)))for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type));else for(const e of r.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type&&"goog-remb"!==e.type));return r},Hr.reduceCodecs=function(e,t){const r=[];if(t){for(let s=0;s<e.length;++s)if(ds(e[s],t)){r.push(e[s]),cs(e[s+1])&&r.push(e[s+1]);break}if(0===r.length)throw new TypeError("no matching codec found")}else r.push(e[0]),cs(e[1])&&r.push(e[1]);return r},Hr.generateProbatorRtpParameters=function(e){rs(e=Zr.clone(e,{}));const t={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:1234}],rtcp:{cname:"probator"}};return t.codecs.push(e.codecs[0]),t.codecs[0].payloadType=127,t.headerExtensions=e.headerExtensions,t},Hr.canSend=function(e,t){return t.codecs.some((t=>t.kind===e))},Hr.canReceive=function(e,t){if(rs(e),0===e.codecs.length)return!1;const r=e.codecs[0];return t.codecs.some((e=>e.remotePayloadType===r.payloadType))};var hs={},us={},ms=C&&C.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(i,n){function a(e){try{c(s.next(e))}catch(e){n(e)}}function o(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(us,"__esModule",{value:!0});us.AwaitQueue=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return ms(this,void 0,void 0,(function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if("function"!=typeof e)throw new TypeError("given Job is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch(e){}return new Promise(((r,s)=>{const i={task:e,name:t,resolve:r,reject:s,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(i),1===this.pendingTasks.length&&this.next()}))}))}stop(){if(!this.closed){for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){const e=new Date;return this.pendingTasks.map((t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0})))}next(){return ms(this,void 0,void 0,(function*(){const e=this.pendingTasks[0];e&&(yield this.executeTask(e),this.pendingTasks.shift(),this.next())}))}executeTask(e){return ms(this,void 0,void 0,(function*(){if(!e.stopped){e.executedAt=new Date;try{const t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}}))}};var fs={};Object.defineProperty(fs,"__esModule",{value:!0}),fs.Producer=void 0;const gs=Rr,ys=$r,_s=new _r.Logger("Producer");class bs extends gs.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:r,track:s,rtpParameters:i,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:c}){super(),this._closed=!1,this._observer=new gs.EnhancedEventEmitter,_s.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=r,this._track=s,this._kind=s.kind,this._rtpParameters=i,this._paused=!!a&&!s.enabled,this._maxSpatialLayer=void 0,this._stopTracks=n,this._disableTrackOnPause=a,this._zeroRtpOnPause=o,this._appData=c,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(_s.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(_s.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new ys.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){_s.debug("pause()"),this._closed?_s.error("pause() | Producer closed"):(this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch((()=>{})),this._observer.safeEmit("pause"))}resume(){_s.debug("resume()"),this._closed?_s.error("resume() | Producer closed"):(this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch((()=>{})),this._observer.safeEmit("resume"))}async replaceTrack({track:e}){if(_s.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch(e){}throw new ys.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new ys.InvalidStateError("track ended");e!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):_s.debug("replaceTrack() | same track, ignored")}async setMaxSpatialLayer(e){if(this._closed)throw new ys.InvalidStateError("closed");if("video"!==this._kind)throw new ys.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new ys.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e)}_onTrackEnded(){_s.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch(e){}}}fs.Producer=bs;var vs={};Object.defineProperty(vs,"__esModule",{value:!0}),vs.Consumer=void 0;const ws=Rr,Ss=$r,Rs=new _r.Logger("Consumer");class Ps extends ws.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:r,rtpReceiver:s,track:i,rtpParameters:n,appData:a}){super(),this._closed=!1,this._observer=new ws.EnhancedEventEmitter,Rs.debug("constructor()"),this._id=e,this._localId=t,this._producerId=r,this._rtpReceiver=s,this._track=i,this._rtpParameters=n,this._paused=!i.enabled,this._appData=a,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Rs.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Rs.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Ss.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){Rs.debug("pause()"),this._closed?Rs.error("pause() | Consumer closed"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"))}resume(){Rs.debug("resume()"),this._closed?Rs.error("resume() | Consumer closed"):(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume"))}_onTrackEnded(){Rs.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._track.stop()}catch(e){}}}vs.Consumer=Ps;var Ts={};Object.defineProperty(Ts,"__esModule",{value:!0}),Ts.DataProducer=void 0;const Cs=Rr,ks=$r,Es=new _r.Logger("DataProducer");class Ds extends Cs.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:r,appData:s}){super(),this._closed=!1,this._observer=new Cs.EnhancedEventEmitter,Es.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=r,this._appData=s,this._handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Es.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Es.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Es.debug("send()"),this._closed)throw new ks.InvalidStateError("closed");this._dataChannel.send(e)}_handleDataChannel(){this._dataChannel.addEventListener("open",(()=>{this._closed||(Es.debug('DataChannel "open" event'),this.safeEmit("open"))})),this._dataChannel.addEventListener("error",(e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?Es.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Es.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)})),this._dataChannel.addEventListener("close",(()=>{this._closed||(Es.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))})),this._dataChannel.addEventListener("message",(()=>{this._closed||Es.warn('DataChannel "message" event in a DataProducer, message discarded')})),this._dataChannel.addEventListener("bufferedamountlow",(()=>{this._closed||this.safeEmit("bufferedamountlow")}))}}Ts.DataProducer=Ds;var xs={};Object.defineProperty(xs,"__esModule",{value:!0}),xs.DataConsumer=void 0;const Os=Rr,Ms=new _r.Logger("DataConsumer");class Is extends Os.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:r,sctpStreamParameters:s,appData:i}){super(),this._closed=!1,this._observer=new Os.EnhancedEventEmitter,Ms.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=r,this._sctpStreamParameters=s,this._appData=i,this._handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Ms.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Ms.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}_handleDataChannel(){this._dataChannel.addEventListener("open",(()=>{this._closed||(Ms.debug('DataChannel "open" event'),this.safeEmit("open"))})),this._dataChannel.addEventListener("error",(e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),"sctp-failure"===t.errorDetail?Ms.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Ms.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)})),this._dataChannel.addEventListener("close",(()=>{this._closed||(Ms.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))})),this._dataChannel.addEventListener("message",(e=>{this._closed||this.safeEmit("message",e.data)}))}}xs.DataConsumer=Is;var js=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Ls=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),As=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&js(t,e,r);return Ls(t,e),t};Object.defineProperty(hs,"__esModule",{value:!0}),hs.Transport=void 0;const Bs=us,Fs=_r,Ns=Rr,Us=$r,zs=As(Gr),$s=As(Hr),Vs=fs,qs=vs,Gs=Ts,Hs=xs,Ws=new Fs.Logger("Transport");class Ks extends Ns.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:r,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,appData:p,handlerFactory:l,extendedRtpCapabilities:h,canProduceByKind:u}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new Bs.AwaitQueue({ClosedErrorClass:Us.InvalidStateError}),this._observer=new Ns.EnhancedEventEmitter,Ws.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=h,this._canProduceByKind=u,this._maxSctpMessageSize=n?n.maxMessageSize:null,delete(c=zs.clone(c,{})).iceServers,delete c.iceTransportPolicy,delete c.bundlePolicy,delete c.rtcpMuxPolicy,delete c.sdpSemantics,this._handler=l(),this._handler.run({direction:e,iceParameters:r,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,extendedRtpCapabilities:h}),this._appData=p,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){Ws.debug("close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new Us.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(Ws.debug("restartIce()"),this._closed)throw new Us.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push((async()=>this._handler.restartIce(e)),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(Ws.debug("updateIceServers()"),this._closed)throw new Us.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push((async()=>this._handler.updateIceServers(e)),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:r,codec:s,stopTracks:i=!0,disableTrackOnPause:n=!0,zeroRtpOnPause:a=!1,appData:o={}}={}){if(Ws.debug("produce() [track:%o]",e),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new Us.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new Us.UnsupportedError(`cannot produce ${e.kind}`);if("ended"===e.readyState)throw new Us.InvalidStateError("track ended");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(o&&"object"!=typeof o)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push((async()=>{let c;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&0===t.length?c=void 0:t&&(c=t.map((e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"==typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t})));const{localId:d,rtpParameters:p,rtpSender:l}=await this._handler.send({track:e,encodings:c,codecOptions:r,codec:s});try{$s.validateRtpParameters(p);const{id:t}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:p,appData:o}),r=new Vs.Producer({id:t,localId:d,rtpSender:l,track:e,rtpParameters:p,stopTracks:i,disableTrackOnPause:n,zeroRtpOnPause:a,appData:o});return this._producers.set(r.id,r),this._handleProducer(r),this._observer.safeEmit("newproducer",r),r}catch(e){throw this._handler.stopSending(d).catch((()=>{})),e}}),"transport.produce()").catch((t=>{if(i)try{e.stop()}catch(e){}throw t}))}async consume({id:e,producerId:t,kind:r,rtpParameters:s,appData:i={}}){if(Ws.debug("consume()"),s=zs.clone(s,void 0),this._closed)throw new Us.InvalidStateError("closed");if("recv"!==this._direction)throw new Us.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==r&&"video"!==r)throw new TypeError(`invalid kind '${r}'`);if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(i&&"object"!=typeof i)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push((async()=>{if(!$s.canReceive(s,this._extendedRtpCapabilities))throw new Us.UnsupportedError("cannot consume this Producer");const{localId:n,rtpReceiver:a,track:o}=await this._handler.receive({trackId:e,kind:r,rtpParameters:s}),c=new qs.Consumer({id:e,localId:n,producerId:t,rtpReceiver:a,track:o,rtpParameters:s,appData:i});if(this._consumers.set(c.id,c),this._handleConsumer(c),!this._probatorConsumerCreated&&"video"===r)try{const e=$s.generateProbatorRtpParameters(c.rtpParameters);await this._handler.receive({trackId:"probator",kind:"video",rtpParameters:e}),Ws.debug("consume() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(e){Ws.error("consume() | failed to create Consumer for RTP probation:%o",e)}return this._observer.safeEmit("newconsumer",c),c}),"transport.consume()")}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:r,priority:s="low",label:i="",protocol:n="",appData:a={}}={}){if(Ws.debug("produceData()"),"send"!==this._direction)throw new Us.UnsupportedError("not a sending Transport");if(!this._maxSctpMessageSize)throw new Us.UnsupportedError("SCTP not enabled by remote Transport");if(!["very-low","low","medium","high"].includes(s))throw new TypeError("wrong priority");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(0===this.listenerCount("producedata"))throw new TypeError('no "producedata" listener set into this transport');if(a&&"object"!=typeof a)throw new TypeError("if given, appData must be an object");return(t||r)&&(e=!1),this._awaitQueue.push((async()=>{const{dataChannel:o,sctpStreamParameters:c}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,priority:s,label:i,protocol:n});$s.validateSctpStreamParameters(c);const{id:d}=await this.safeEmitAsPromise("producedata",{sctpStreamParameters:c,label:i,protocol:n,appData:a}),p=new Gs.DataProducer({id:d,dataChannel:o,sctpStreamParameters:c,appData:a});return this._dataProducers.set(p.id,p),this._handleDataProducer(p),this._observer.safeEmit("newdataproducer",p),p}),"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:r,label:s="",protocol:i="",appData:n={}}){if(Ws.debug("consumeData()"),r=zs.clone(r,void 0),this._closed)throw new Us.InvalidStateError("closed");if("recv"!==this._direction)throw new Us.UnsupportedError("not a receiving Transport");if(!this._maxSctpMessageSize)throw new Us.UnsupportedError("SCTP not enabled by remote Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing dataProducerId");if(0===this.listenerCount("connect")&&"new"===this._connectionState)throw new TypeError('no "connect" listener set into this transport');if(n&&"object"!=typeof n)throw new TypeError("if given, appData must be an object");return $s.validateSctpStreamParameters(r),this._awaitQueue.push((async()=>{const{dataChannel:a}=await this._handler.receiveDataChannel({sctpStreamParameters:r,label:s,protocol:i}),o=new Hs.DataConsumer({id:e,dataProducerId:t,dataChannel:a,sctpStreamParameters:r,appData:n});return this._dataConsumers.set(o.id,o),this._handleDataConsumer(o),this._observer.safeEmit("newdataconsumer",o),o}),"transport.consumeData()")}_handleHandler(){const e=this._handler;e.on("@connect",(({dtlsParameters:e},t,r)=>{this._closed?r(new Us.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,r)})),e.on("@connectionstatechange",(e=>{e!==this._connectionState&&(Ws.debug("connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))}))}_handleProducer(e){e.on("@close",(()=>{this._producers.delete(e.id),this._closed||this._awaitQueue.push((async()=>this._handler.stopSending(e.localId)),"producer @close event").catch((e=>Ws.warn("producer.close() failed:%o",e)))})),e.on("@replacetrack",((t,r,s)=>{this._awaitQueue.push((async()=>this._handler.replaceTrack(e.localId,t)),"producer @replacetrack event").then(r).catch(s)})),e.on("@setmaxspatiallayer",((t,r,s)=>{this._awaitQueue.push((async()=>this._handler.setMaxSpatialLayer(e.localId,t)),"producer @setmaxspatiallayer event").then(r).catch(s)})),e.on("@setrtpencodingparameters",((t,r,s)=>{this._awaitQueue.push((async()=>this._handler.setRtpEncodingParameters(e.localId,t)),"producer @setrtpencodingparameters event").then(r).catch(s)})),e.on("@getstats",((t,r)=>{if(this._closed)return r(new Us.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(r)}))}_handleConsumer(e){e.on("@close",(()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push((async()=>this._handler.stopReceiving(e.localId)),"consumer @close event").catch((()=>{}))})),e.on("@getstats",((t,r)=>{if(this._closed)return r(new Us.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(r)}))}_handleDataProducer(e){e.on("@close",(()=>{this._dataProducers.delete(e.id)}))}_handleDataConsumer(e){e.on("@close",(()=>{this._dataConsumers.delete(e.id)}))}}hs.Transport=Ks;var Ys={},Qs={},Js={},Zs={exports:{}},Xs=Zs.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Xs).forEach((function(e){Xs[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))})),function(e){var t=function(e){return String(Number(e))===e?Number(e):e},r=function(e,r,s){var i=e.name&&e.names;e.push&&!r[e.push]?r[e.push]=[]:i&&!r[e.name]&&(r[e.name]={});var n=e.push?{}:i?r[e.name]:r;!function(e,r,s,i){if(i&&!s)r[i]=t(e[1]);else for(var n=0;n<s.length;n+=1)null!=e[n+1]&&(r[s[n]]=t(e[n+1]))}(s.match(e.reg),n,e.names,e.name),e.push&&r[e.push].push(n)},s=Zs.exports,i=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},n=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(i).forEach((function(e){var t=e[0],i=e.slice(2);"m"===t&&(n.push({rtp:[],fmtp:[]}),a=n[n.length-1]);for(var o=0;o<(s[t]||[]).length;o+=1){var c=s[t][o];if(c.reg.test(i))return r(c,a,i)}})),t.media=n,t};var n=function(e,r){var s=r.split(/=(.+)/,2);return 2===s.length?e[s[0]]=t(s[1]):1===s.length&&r.length>1&&(e[s[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(n,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var r=[],s=e.split(" ").map(t),i=0;i<s.length;i+=3)r.push({component:s[i],ip:s[i+1],port:s[i+2]});return r},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(n,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var r,s=!1;return"~"!==e[0]?r=t(e):(r=t(e.substring(1,e.length)),s=!0),{scid:r,paused:s}}))}))}}(Js);var ei=Zs.exports,ti=/%[sdv%]/g,ri=function(e){var t=1,r=arguments,s=r.length;return e.replace(ti,(function(e){if(t>=s)return e;var i=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))},si=function(e,t,r){var s=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var i=0;i<t.names.length;i+=1){var n=t.names[i];t.name?s.push(r[t.name][n]):s.push(r[t.names[i]])}else s.push(r[t.name]);return ri.apply(null,s)},ii=["v","o","s","i","u","e","p","c","b","t","r","z","a"],ni=["i","c","b","a"],ai=Js,oi=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var r=t.outerOrder||ii,s=t.innerOrder||ni,i=[];return r.forEach((function(t){ei[t].forEach((function(r){r.name in e&&null!=e[r.name]?i.push(si(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){i.push(si(t,r,e))}))}))})),e.media.forEach((function(e){i.push(si("m",ei.m[0],e)),s.forEach((function(t){ei[t].forEach((function(r){r.name in e&&null!=e[r.name]?i.push(si(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){i.push(si(t,r,e))}))}))}))})),i.join("\r\n")+"\r\n"};Qs.write=oi,Qs.parse=ai.parse,Qs.parseParams=ai.parseParams,Qs.parseFmtpConfig=ai.parseFmtpConfig,Qs.parsePayloads=ai.parsePayloads,Qs.parseRemoteCandidates=ai.parseRemoteCandidates,Qs.parseImageAttributes=ai.parseImageAttributes,Qs.parseSimulcastStreamList=ai.parseSimulcastStreamList;var ci={},di=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),pi=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),li=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&di(t,e,r);return pi(t,e),t};Object.defineProperty(ci,"__esModule",{value:!0}),ci.applyCodecParameters=ci.getCname=ci.extractDtlsParameters=ci.extractRtpCapabilities=void 0;const hi=li(Qs);ci.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,r=[];let s=!1,i=!1;for(const n of e.media){const e=n.type;switch(e){case"audio":if(s)continue;s=!0;break;case"video":if(i)continue;i=!0;break;default:continue}for(const r of n.rtp){const s={kind:e,mimeType:`${e}/${r.codec}`,preferredPayloadType:r.payload,clockRate:r.rate,channels:r.encoding,parameters:{},rtcpFeedback:[]};t.set(s.preferredPayloadType,s)}for(const e of n.fmtp||[]){const r=hi.parseParams(e.config),s=t.get(e.payload);s&&(r&&r["profile-level-id"]&&(r["profile-level-id"]=String(r["profile-level-id"])),s.parameters=r)}for(const e of n.rtcpFb||[]){const r=t.get(e.payload);if(!r)continue;const s={type:e.type,parameter:e.subtype};s.parameter||delete s.parameter,r.rtcpFeedback.push(s)}for(const t of n.ext||[]){if(t["encrypt-uri"])continue;const s={kind:e,uri:t.uri,preferredId:t.value};r.push(s)}}return{codecs:Array.from(t.values()),headerExtensions:r}},ci.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find((e=>e.iceUfrag&&0!==e.port));if(!t)throw new Error("no active media section found");const r=t.fingerprint||e.fingerprint;let s;switch(t.setup){case"active":s="client";break;case"passive":s="server";break;case"actpass":s="auto"}return{role:s,fingerprints:[{algorithm:r.type,value:r.hash}]}},ci.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find((e=>"cname"===e.attribute));return t?t.value:""},ci.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const r of e.codecs){const e=r.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find((e=>e.payload===r.payloadType)))continue;t.fmtp=t.fmtp||[];let s=t.fmtp.find((e=>e.payload===r.payloadType));s||(s={payload:r.payloadType,config:""},t.fmtp.push(s));const i=hi.parseParams(s.config);switch(e){case"audio/opus":{const e=r.parameters["sprop-stereo"];void 0!==e&&(i.stereo=e?1:0);break}}s.config="";for(const e of Object.keys(i))s.config&&(s.config+=";"),s.config+=`${e}=${i[e]}`}};var ui={};Object.defineProperty(ui,"__esModule",{value:!0}),ui.addLegacySimulcast=ui.getRtpEncodings=void 0,ui.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const r of e.ssrcs||[]){const e=r.id;t.add(e)}if(0===t.size)throw new Error("no a=ssrc lines found");const r=new Map;for(const s of e.ssrcGroups||[]){if("FID"!==s.semantics)continue;let[e,i]=s.ssrcs.split(/\s+/);e=Number(e),i=Number(i),t.has(e)&&(t.delete(e),t.delete(i),r.set(e,i))}for(const e of t)r.set(e,null);const s=[];for(const[e,t]of r){const r={ssrc:e};t&&(r.rtx={ssrc:t}),s.push(r)}return s},ui.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const r=(e.ssrcs||[]).find((e=>"msid"===e.attribute));if(!r)throw new Error("a=ssrc line with msid information not found");const[s,i]=r.value.split(" ")[0],n=r.id;let a;(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===n&&(a=Number(t[1]),!0)}));const o=e.ssrcs.find((e=>"cname"===e.attribute));if(!o)throw new Error("a=ssrc line with cname information not found");const c=o.value,d=[],p=[];for(let e=0;e<t;++e)d.push(n+e),a&&p.push(a+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let t=0;t<d.length;++t){const r=d[t];e.ssrcs.push({id:r,attribute:"cname",value:c}),e.ssrcs.push({id:r,attribute:"msid",value:`${s} ${i}`})}for(let t=0;t<p.length;++t){const r=d[t],n=p[t];e.ssrcs.push({id:n,attribute:"cname",value:c}),e.ssrcs.push({id:n,attribute:"msid",value:`${s} ${i}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${r} ${n}`})}};var mi={};Object.defineProperty(mi,"__esModule",{value:!0}),mi.HandlerInterface=void 0;const fi=Rr;class gi extends fi.EnhancedEventEmitter{constructor(){super()}}mi.HandlerInterface=gi;var yi={},_i={},bi=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),vi=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),wi=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&bi(t,e,r);return vi(t,e),t};Object.defineProperty(_i,"__esModule",{value:!0}),_i.OfferMediaSection=_i.AnswerMediaSection=_i.MediaSection=void 0;const Si=wi(Gr);class Ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:s=!1}){if(this._mediaObject={},this._planB=s,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}r&&this.setDtlsRole(r.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return 0===this._mediaObject.port}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){this._mediaObject.direction="inactive",delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}_i.MediaSection=Ri;_i.AnswerMediaSection=class extends Ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:s,plainRtpParameters:i,planB:n=!1,offerMediaObject:a,offerRtpParameters:o,answerRtpParameters:c,codecOptions:d,extmapAllowMixed:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:n}),this._mediaObject.mid=String(a.mid),this._mediaObject.type=a.type,this._mediaObject.protocol=a.protocol,i?(this._mediaObject.connection={ip:i.ip,version:i.ipVersion},this._mediaObject.port=i.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),a.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of c.codecs){const t={payload:e.payloadType,codec:Pi(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const r=Si.clone(e.parameters,{});if(d){const{opusStereo:t,opusFec:s,opusDtx:i,opusMaxPlaybackRate:n,opusMaxAverageBitrate:a,opusPtime:c,videoGoogleStartBitrate:p,videoGoogleMaxBitrate:l,videoGoogleMinBitrate:h}=d,u=o.codecs.find((t=>t.payloadType===e.payloadType));switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(u.parameters["sprop-stereo"]=t?1:0,r.stereo=t?1:0),void 0!==s&&(u.parameters.useinbandfec=s?1:0,r.useinbandfec=s?1:0),void 0!==i&&(u.parameters.usedtx=i?1:0,r.usedtx=i?1:0),void 0!==n&&(r.maxplaybackrate=n),void 0!==a&&(r.maxaveragebitrate=a),void 0!==c&&(u.parameters.ptime=c,r.ptime=c);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==p&&(r["x-google-start-bitrate"]=p),void 0!==l&&(r["x-google-max-bitrate"]=l),void 0!==h&&(r["x-google-min-bitrate"]=h)}}const s={payload:e.payloadType,config:""};for(const e of Object.keys(r))s.config&&(s.config+=";"),s.config+=`${e}=${r[e]}`;s.config&&this._mediaObject.fmtp.push(s);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=c.codecs.map((e=>e.payloadType)).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions){(a.ext||[]).some((t=>t.uri===e.uri))&&this._mediaObject.ext.push({uri:e.uri,value:e.id})}if(p&&"extmap-allow-mixed"===a.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),a.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:a.simulcast.list1},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(a.simulcast_03){this._mediaObject.simulcast_03={value:a.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of a.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof a.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=s.port,this._mediaObject.maxMessageSize=s.maxMessageSize):a.sctpmap&&(this._mediaObject.payloads=s.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:s.port,maxMessageSize:s.maxMessageSize})}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}};function Pi(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}_i.OfferMediaSection=class extends Ri{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:s,plainRtpParameters:i,planB:n=!1,mid:a,kind:o,offerRtpParameters:c,streamId:d,trackId:p,oldDataChannelSpec:l=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:n}),this._mediaObject.mid=String(a),this._mediaObject.type=o,i?(this._mediaObject.connection={ip:i.ip,version:i.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=i.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=s?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),o){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${d||"-"} ${p}`);for(const e of c.codecs){const t={payload:e.payloadType,codec:Pi(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const r={payload:e.payloadType,config:""};for(const t of Object.keys(e.parameters))r.config&&(r.config+=";"),r.config+=`${t}=${e.parameters[t]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=c.codecs.map((e=>e.payloadType)).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,r=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${d||"-"} ${p}`}),r&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:r,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:r,attribute:"msid",value:`${d||"-"} ${p}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${r}`}));break}case"application":l?(this._mediaObject.payloads=s.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:s.port,maxMessageSize:s.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=s.port,this._mediaObject.maxMessageSize=s.maxMessageSize)}}setDtlsRole(e){this._mediaObject.setup="actpass"}planBReceive({offerRtpParameters:e,streamId:t,trackId:r}){const s=e.encodings[0],i=s.ssrc,n=s.rtx&&s.rtx.ssrc?s.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${t||"-"} ${r}`}),n&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${r}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${n}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],r=t.ssrc,s=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter((e=>e.id!==r&&e.id!==s)),s&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter((e=>e.ssrcs!==`${r} ${s}`)))}};var Ti=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Ci=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),ki=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Ti(t,e,r);return Ci(t,e),t};Object.defineProperty(yi,"__esModule",{value:!0}),yi.RemoteSdp=void 0;const Ei=ki(Qs),Di=_i,xi=new _r.Logger("RemoteSdp");yi.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:s,plainRtpParameters:i,planB:n=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=r,this._sctpParameters=s,this._plainRtpParameters=i,this._planB=n,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),r){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:r.fingerprints[e-1].algorithm,hash:r.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}i&&(this._sdpObject.origin.address=i.ip,this._sdpObject.origin.ipVer=i.ipVersion)}updateIceParameters(e){xi.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){xi.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:r,answerRtpParameters:s,codecOptions:i,extmapAllowMixed:n=!1}){const a=new Di.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:r,answerRtpParameters:s,codecOptions:i,extmapAllowMixed:n});t?this._replaceMediaSection(a,t):this._midToIndex.has(a.mid)?this._replaceMediaSection(a):this._addMediaSection(a)}receive({mid:e,kind:t,offerRtpParameters:r,streamId:s,trackId:i}){const n=this._midToIndex.get(e);let a;if(void 0!==n&&(a=this._mediaSections[n]),a)a.planBReceive({offerRtpParameters:r,streamId:s,trackId:i}),this._replaceMediaSection(a);else{a=new Di.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:r,streamId:s,trackId:i});const n=this._mediaSections.find((e=>e.closed));n?this._replaceMediaSection(a,n.mid):this._addMediaSection(a)}}disableMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)throw new Error(`no media section found with mid '${e}'`);this._mediaSections[t].disable()}closeMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)throw new Error(`no media section found with mid '${e}'`);const r=this._mediaSections[t];if(e===this._firstMid)return xi.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),void this.disableMediaSection(e);r.close(),this._regenerateBundleMids()}planBStopReceiving({mid:e,offerRtpParameters:t}){const r=this._midToIndex.get(e);if(void 0===r)throw new Error(`no media section found with mid '${e}'`);const s=this._mediaSections[r];s.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(s)}sendSctpAssociation({offerMediaObject:e}){const t=new Di.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new Di.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,Ei.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if("string"==typeof t){const r=this._midToIndex.get(t);if(void 0===r)throw new Error(`no media section found for reuseMid '${t}'`);const s=this._mediaSections[r];this._mediaSections[r]=e,this._midToIndex.delete(s.mid),this._midToIndex.set(e.mid,r),this._sdpObject.media[r]=e.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(e.mid);if(void 0===t)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject()}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter((e=>!e.closed)).map((e=>e.mid)).join(" "))}};var Oi={};Object.defineProperty(Oi,"__esModule",{value:!0}),Oi.parse=void 0;const Mi=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");Oi.parse=function(e){const t=Mi.exec(e||"");return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}};var Ii=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),ji=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Li=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Ii(t,e,r);return ji(t,e),t};Object.defineProperty(Ys,"__esModule",{value:!0}),Ys.Chrome74=void 0;const Ai=Li(Qs),Bi=_r,Fi=Li(Gr),Ni=Li(Hr),Ui=Li(ci),zi=Li(ui),$i=mi,Vi=yi,qi=Oi,Gi=new Bi.Logger("Chrome74"),Hi={OS:1024,MIS:1024};class Wi extends $i.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new Wi}get name(){return"Chrome74"}close(){if(Gi.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){Gi.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=Ai.parse(t.sdp);return Ui.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return Gi.debug("getNativeSctpCapabilities()"),{numStreams:Hi}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){Gi.debug("run()"),this._direction=e,this._remoteSdp=new Vi.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i}),this._sendingRtpParametersByKind={audio:Ni.getSendingRtpParameters("audio",d),video:Ni.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:Ni.getSendingRemoteRtpParameters("audio",d),video:Ni.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){Gi.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(Gi.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});Gi.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};Gi.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};Gi.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();Gi.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),Gi.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach(((e,t)=>{e.rid=`r${t}`}));const i=Fi.clone(this._sendingRtpParametersByKind[e.kind],{});i.codecs=Ni.reduceCodecs(i.codecs,s);const n=Fi.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});n.codecs=Ni.reduceCodecs(n.codecs,s);const a=this._remoteSdp.getNextMediaSectionIdx(),o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let c,d=await this._pc.createOffer(),p=Ai.parse(d.sdp);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p});let l=!1;const h=qi.parse((t||[{}])[0].scalabilityMode);t&&1===t.length&&h.spatialLayers>1&&"video/vp9"===i.codecs[0].mimeType.toLowerCase()&&(Gi.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,p=Ai.parse(d.sdp),c=p.media[a.idx],zi.addLegacySimulcast({offerMediaObject:c,numStreams:h.spatialLayers}),d={type:"offer",sdp:Ai.write(p)}),Gi.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const u=o.mid;if(i.mid=u,p=Ai.parse(this._pc.localDescription.sdp),c=p.media[a.idx],i.rtcp.cname=Ui.getCname({offerMediaObject:c}),t)if(1===t.length){let e=zi.getRtpEncodings({offerMediaObject:c});Object.assign(e[0],t[0]),l&&(e=[e[0]]),i.encodings=e}else i.encodings=t;else i.encodings=zi.getRtpEncodings({offerMediaObject:c});if(i.encodings.length>1&&("video/vp8"===i.codecs[0].mimeType.toLowerCase()||"video/h264"===i.codecs[0].mimeType.toLowerCase()))for(const e of i.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:a.reuseMid,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r,extmapAllowMixed:!0});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return Gi.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(u,o),{localId:u,rtpParameters:i,rtpSender:o.sender}}async stopSending(e){this._assertSendDirection(),Gi.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();Gi.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};Gi.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?Gi.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Gi.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),Gi.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.sender.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),Gi.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.sender.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:i,priority:n};Gi.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Hi.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=Ai.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),Gi.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};Gi.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),Gi.debug("receive() [trackId:%s, kind:%s]",e,t);const s=r.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const i={type:"offer",sdp:this._remoteSdp.getSdp()};Gi.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Ai.parse(n.sdp),o=a.media.find((e=>String(e.mid)===s));Ui.applyCodecParameters({offerRtpParameters:r,answerMediaObject:o}),n={type:"answer",sdp:Ai.write(a)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:a}),Gi.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);const c=this._pc.getTransceivers().find((e=>e.mid===s));if(!c)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,c),{localId:s,track:c.receiver.track,rtpReceiver:c.receiver}}async stopReceiving(e){this._assertRecvDirection(),Gi.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};Gi.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const s=await this._pc.createAnswer();Gi.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a,protocol:r};Gi.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};Gi.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=Ai.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}Gi.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ai.parse(this._pc.localDescription.sdp));const r=Ui.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}Ys.Chrome74=Wi;var Ki={},Yi=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Qi=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Ji=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Yi(t,e,r);return Qi(t,e),t};Object.defineProperty(Ki,"__esModule",{value:!0}),Ki.Chrome70=void 0;const Zi=Ji(Qs),Xi=_r,en=Ji(Gr),tn=Ji(Hr),rn=Ji(ci),sn=Ji(ui),nn=mi,an=yi,on=Oi,cn=new Xi.Logger("Chrome70"),dn={OS:1024,MIS:1024};class pn extends nn.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new pn}get name(){return"Chrome70"}close(){if(cn.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){cn.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=Zi.parse(t.sdp);return rn.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return cn.debug("getNativeSctpCapabilities()"),{numStreams:dn}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){cn.debug("run()"),this._direction=e,this._remoteSdp=new an.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i}),this._sendingRtpParametersByKind={audio:tn.getSendingRtpParameters("audio",d),video:tn.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:tn.getSendingRemoteRtpParameters("audio",d),video:tn.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){cn.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(cn.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});cn.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};cn.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};cn.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();cn.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),cn.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const i=en.clone(this._sendingRtpParametersByKind[e.kind],{});i.codecs=tn.reduceCodecs(i.codecs,s);const n=en.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});n.codecs=tn.reduceCodecs(n.codecs,s);const a=this._remoteSdp.getNextMediaSectionIdx(),o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let c,d=await this._pc.createOffer(),p=Zi.parse(d.sdp);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p}),t&&t.length>1&&(cn.debug("send() | enabling legacy simulcast"),p=Zi.parse(d.sdp),c=p.media[a.idx],sn.addLegacySimulcast({offerMediaObject:c,numStreams:t.length}),d={type:"offer",sdp:Zi.write(p)});let l=!1;const h=on.parse((t||[{}])[0].scalabilityMode);if(t&&1===t.length&&h.spatialLayers>1&&"video/vp9"===i.codecs[0].mimeType.toLowerCase()&&(cn.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,p=Zi.parse(d.sdp),c=p.media[a.idx],sn.addLegacySimulcast({offerMediaObject:c,numStreams:h.spatialLayers}),d={type:"offer",sdp:Zi.write(p)}),cn.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),t){cn.debug("send() | applying given encodings");const e=o.sender.getParameters();for(let r=0;r<(e.encodings||[]).length;++r){const s=e.encodings[r],i=t[r];if(!i)break;e.encodings[r]=Object.assign(s,i)}await o.sender.setParameters(e)}const u=o.mid;if(i.mid=u,p=Zi.parse(this._pc.localDescription.sdp),c=p.media[a.idx],i.rtcp.cname=rn.getCname({offerMediaObject:c}),i.encodings=sn.getRtpEncodings({offerMediaObject:c}),t)for(let e=0;e<i.encodings.length;++e)t[e]&&Object.assign(i.encodings[e],t[e]);if(l&&(i.encodings=[i.encodings[0]]),i.encodings.length>1&&("video/vp8"===i.codecs[0].mimeType.toLowerCase()||"video/h264"===i.codecs[0].mimeType.toLowerCase()))for(const e of i.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:a.reuseMid,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return cn.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(u,o),{localId:u,rtpParameters:i,rtpSender:o.sender}}async stopSending(e){this._assertSendDirection(),cn.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();cn.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};cn.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?cn.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):cn.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),cn.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.sender.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),cn.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.sender.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:i,priority:n};cn.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%dn.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=Zi.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),cn.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};cn.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),cn.debug("receive() [trackId:%s, kind:%s]",e,t);const s=r.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const i={type:"offer",sdp:this._remoteSdp.getSdp()};cn.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Zi.parse(n.sdp),o=a.media.find((e=>String(e.mid)===s));rn.applyCodecParameters({offerRtpParameters:r,answerMediaObject:o}),n={type:"answer",sdp:Zi.write(a)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:a}),cn.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);const c=this._pc.getTransceivers().find((e=>e.mid===s));if(!c)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,c),{localId:s,track:c.receiver.track,rtpReceiver:c.receiver}}async stopReceiving(e){this._assertRecvDirection(),cn.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};cn.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const s=await this._pc.createAnswer();cn.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmitTime:n,maxRetransmits:a,protocol:r};cn.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};cn.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=Zi.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}cn.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Zi.parse(this._pc.localDescription.sdp));const r=rn.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}Ki.Chrome70=pn;var ln={},hn={};Object.defineProperty(hn,"__esModule",{value:!0}),hn.addLegacySimulcast=hn.getRtpEncodings=void 0,hn.getRtpEncodings=function({offerMediaObject:e,track:t}){const r=new Set;for(const s of e.ssrcs||[]){if("msid"!==s.attribute)continue;if(s.value.split(" ")[1]===t.id){const e=s.id;r.add(e)}}if(0===r.size)throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);const s=new Map;for(const t of e.ssrcGroups||[]){if("FID"!==t.semantics)continue;let[e,i]=t.ssrcs.split(/\s+/);e=Number(e),i=Number(i),r.has(e)&&(r.delete(e),r.delete(i),s.set(e,i))}for(const e of r)s.set(e,null);const i=[];for(const[e,t]of s){const r={ssrc:e};t&&(r.rtx={ssrc:t}),i.push(r)}return i},hn.addLegacySimulcast=function({offerMediaObject:e,track:t,numStreams:r}){if(r<=1)throw new TypeError("numStreams must be greater than 1");let s,i,n;if(!(e.ssrcs||[]).find((e=>{if("msid"!==e.attribute)return!1;return e.value.split(" ")[1]===t.id&&(s=e.id,n=e.value.split(" ")[0],!0)})))throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===s&&(i=Number(t[1]),!0)}));const a=e.ssrcs.find((e=>"cname"===e.attribute&&e.id===s));if(!a)throw new Error(`a=ssrc line with cname information not found [track.id:${t.id}]`);const o=a.value,c=[],d=[];for(let e=0;e<r;++e)c.push(s+e),i&&d.push(i+e);e.ssrcGroups=e.ssrcGroups||[],e.ssrcs=e.ssrcs||[],e.ssrcGroups.push({semantics:"SIM",ssrcs:c.join(" ")});for(let r=0;r<c.length;++r){const s=c[r];e.ssrcs.push({id:s,attribute:"cname",value:o}),e.ssrcs.push({id:s,attribute:"msid",value:`${n} ${t.id}`})}for(let r=0;r<d.length;++r){const s=c[r],i=d[r];e.ssrcs.push({id:i,attribute:"cname",value:o}),e.ssrcs.push({id:i,attribute:"msid",value:`${n} ${t.id}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${i}`})}};var un=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),mn=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),fn=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&un(t,e,r);return mn(t,e),t};Object.defineProperty(ln,"__esModule",{value:!0}),ln.Chrome67=void 0;const gn=fn(Qs),yn=_r,_n=fn(Gr),bn=fn(Hr),vn=fn(ci),wn=fn(hn),Sn=mi,Rn=yi,Pn=new yn.Logger("Chrome67"),Tn={OS:1024,MIS:1024};class Cn extends Sn.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new Cn}get name(){return"Chrome67"}close(){if(Pn.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){Pn.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=gn.parse(t.sdp);return vn.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return Pn.debug("getNativeSctpCapabilities()"),{numStreams:Tn}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){Pn.debug("run()"),this._direction=e,this._remoteSdp=new Rn.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,planB:!0}),this._sendingRtpParametersByKind={audio:bn.getSendingRtpParameters("audio",d),video:bn.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:bn.getSendingRemoteRtpParameters("audio",d),video:bn.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){Pn.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(Pn.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});Pn.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};Pn.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};Pn.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();Pn.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),Pn.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),s&&Pn.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let i,n=await this._pc.createOffer(),a=gn.parse(n.sdp);const o=_n.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=bn.reduceCodecs(o.codecs);const c=_n.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(c.codecs=bn.reduceCodecs(c.codecs),this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:a}),"video"===e.kind&&t&&t.length>1&&(Pn.debug("send() | enabling simulcast"),a=gn.parse(n.sdp),i=a.media.find((e=>"video"===e.type)),wn.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:gn.write(a)}),Pn.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=gn.parse(this._pc.localDescription.sdp),i=a.media.find((t=>t.type===e.kind)),o.rtcp.cname=vn.getCname({offerMediaObject:i}),o.encodings=wn.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<o.encodings.length;++e)t[e]&&Object.assign(o.encodings[e],t[e]);if(o.encodings.length>1&&"video/vp8"===o.codecs[0].mimeType.toLowerCase())for(const e of o.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:o,answerRtpParameters:c,codecOptions:r});const d={type:"answer",sdp:this._remoteSdp.getSdp()};Pn.debug("send() | calling pc.setRemoteDescription() [answer:%o]",d),await this._pc.setRemoteDescription(d);const p=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find((t=>t.track===e));return this._mapSendLocalIdRtpSender.set(p,l),{localId:p,rtpParameters:o,rtpSender:l}}async stopSending(e){this._assertSendDirection(),Pn.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();Pn.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void Pn.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const s={type:"answer",sdp:this._remoteSdp.getSdp()};Pn.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?Pn.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Pn.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.track;await r.replaceTrack(t),s&&this._sendStream.removeTrack(s),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),Pn.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),Pn.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:i,priority:n};Pn.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Tn.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=gn.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),Pn.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};Pn.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),Pn.debug("receive() [trackId:%s, kind:%s]",e,t);const s=e,i=t;this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};Pn.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=gn.parse(a.sdp),c=o.media.find((e=>String(e.mid)===i));vn.applyCodecParameters({offerRtpParameters:r,answerMediaObject:c}),a={type:"answer",sdp:gn.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),Pn.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);const d=this._pc.getReceivers().find((e=>e.track&&e.track.id===s));if(!d)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(s,{mid:i,rtpParameters:r,rtpReceiver:d}),{localId:s,track:d.track,rtpReceiver:d}}async stopReceiving(e){this._assertRecvDirection(),Pn.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const s={type:"offer",sdp:this._remoteSdp.getSdp()};Pn.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);const i=await this._pc.createAnswer();Pn.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmitTime:n,maxRetransmits:a,protocol:r};Pn.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};Pn.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=gn.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}Pn.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=gn.parse(this._pc.localDescription.sdp));const r=vn.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}ln.Chrome67=Cn;var kn={},En=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Dn=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),xn=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&En(t,e,r);return Dn(t,e),t};Object.defineProperty(kn,"__esModule",{value:!0}),kn.Chrome55=void 0;const On=xn(Qs),Mn=_r,In=$r,jn=xn(Gr),Ln=xn(Hr),An=xn(ci),Bn=xn(hn),Fn=mi,Nn=yi,Un=new Mn.Logger("Chrome55"),zn={OS:1024,MIS:1024};class $n extends Fn.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new $n}get name(){return"Chrome55"}close(){if(Un.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){Un.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=On.parse(t.sdp);return An.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return Un.debug("getNativeSctpCapabilities()"),{numStreams:zn}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){Un.debug("run()"),this._direction=e,this._remoteSdp=new Nn.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,planB:!0}),this._sendingRtpParametersByKind={audio:Ln.getSendingRtpParameters("audio",d),video:Ln.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:Ln.getSendingRemoteRtpParameters("audio",d),video:Ln.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){Un.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(Un.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});Un.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};Un.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};Un.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();Un.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),Un.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),s&&Un.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let i,n=await this._pc.createOffer(),a=On.parse(n.sdp);const o=jn.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=Ln.reduceCodecs(o.codecs);const c=jn.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(c.codecs=Ln.reduceCodecs(c.codecs),this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:a}),"video"===e.kind&&t&&t.length>1&&(Un.debug("send() | enabling simulcast"),a=On.parse(n.sdp),i=a.media.find((e=>"video"===e.type)),Bn.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:On.write(a)}),Un.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=On.parse(this._pc.localDescription.sdp),i=a.media.find((t=>t.type===e.kind)),o.rtcp.cname=An.getCname({offerMediaObject:i}),o.encodings=Bn.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<o.encodings.length;++e)t[e]&&Object.assign(o.encodings[e],t[e]);if(o.encodings.length>1&&"video/vp8"===o.codecs[0].mimeType.toLowerCase())for(const e of o.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:o,answerRtpParameters:c,codecOptions:r});const d={type:"answer",sdp:this._remoteSdp.getSdp()};Un.debug("send() | calling pc.setRemoteDescription() [answer:%o]",d),await this._pc.setRemoteDescription(d);const p=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(p,e),{localId:p,rtpParameters:o}}async stopSending(e){this._assertSendDirection(),Un.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();Un.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void Un.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const s={type:"answer",sdp:this._remoteSdp.getSdp()};Un.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){throw new In.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new In.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new In.UnsupportedError("not supported")}async getSenderStats(e){throw new In.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:i,priority:n};Un.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%zn.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=On.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),Un.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};Un.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),Un.debug("receive() [trackId:%s, kind:%s]",e,t);const s=e,i=t,n=r.rtcp.cname;this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:n,trackId:e});const a={type:"offer",sdp:this._remoteSdp.getSdp()};Un.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);let o=await this._pc.createAnswer();const c=On.parse(o.sdp),d=c.media.find((e=>String(e.mid)===i));An.applyCodecParameters({offerRtpParameters:r,answerMediaObject:d}),o={type:"answer",sdp:On.write(c)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:c}),Un.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);const p=this._pc.getRemoteStreams().find((e=>e.id===n)).getTrackById(s);if(!p)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(s,{mid:i,rtpParameters:r}),{localId:s,track:p}}async stopReceiving(e){this._assertRecvDirection(),Un.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const s={type:"offer",sdp:this._remoteSdp.getSdp()};Un.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);const i=await this._pc.createAnswer();Un.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){throw new In.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmitTime:n,maxRetransmits:a,protocol:r};Un.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};Un.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=On.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}Un.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=On.parse(this._pc.localDescription.sdp));const r=An.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}kn.Chrome55=$n;var Vn={},qn=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Gn=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Hn=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&qn(t,e,r);return Gn(t,e),t};Object.defineProperty(Vn,"__esModule",{value:!0}),Vn.Firefox60=void 0;const Wn=Hn(Qs),Kn=_r,Yn=$r,Qn=Hn(Gr),Jn=Hn(Hr),Zn=Hn(ci),Xn=Hn(ui),ea=mi,ta=yi,ra=new Kn.Logger("Firefox60"),sa={OS:16,MIS:2048};class ia extends ea.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ia}get name(){return"Firefox60"}close(){if(ra.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){ra.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const r=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const s=e.addTransceiver(r,{direction:"sendrecv"}),i=s.sender.getParameters(),n=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];i.encodings=n,await s.sender.setParameters(i);const a=await e.createOffer();try{t.remove()}catch(e){}try{r.stop()}catch(e){}try{e.close()}catch(e){}const o=Wn.parse(a.sdp);return Zn.extractRtpCapabilities({sdpObject:o})}catch(s){try{t.remove()}catch(e){}try{r.stop()}catch(e){}try{e.close()}catch(e){}throw s}}async getNativeSctpCapabilities(){return ra.debug("getNativeSctpCapabilities()"),{numStreams:sa}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){ra.debug("run()"),this._direction=e,this._remoteSdp=new ta.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i}),this._sendingRtpParametersByKind={audio:Jn.getSendingRtpParameters("audio",d),video:Jn.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:Jn.getSendingRemoteRtpParameters("audio",d),video:Jn.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){throw new Yn.UnsupportedError("not supported")}async restartIce(e){if(ra.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});ra.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};ra.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};ra.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();ra.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),ra.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=Qn.clone(t,[])).length>1&&(t.forEach(((e,t)=>{e.rid=`r${t}`})),t.reverse());const i=Qn.clone(this._sendingRtpParametersByKind[e.kind],{});i.codecs=Jn.reduceCodecs(i.codecs,s);const n=Qn.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});n.codecs=Jn.reduceCodecs(n.codecs,s);const a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const e=a.sender.getParameters();e.encodings=t,await a.sender.setParameters(e)}const o=await this._pc.createOffer();let c=Wn.parse(o.sdp);this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:c}),ra.debug("send() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const d=a.mid;i.mid=d,c=Wn.parse(this._pc.localDescription.sdp);const p=c.media[c.media.length-1];if(i.rtcp.cname=Zn.getCname({offerMediaObject:p}),t)if(1===t.length){const e=Xn.getRtpEncodings({offerMediaObject:p});Object.assign(e[0],t[0]),i.encodings=e}else i.encodings=t.reverse();else i.encodings=Xn.getRtpEncodings({offerMediaObject:p});if(i.encodings.length>1&&("video/vp8"===i.codecs[0].mimeType.toLowerCase()||"video/h264"===i.codecs[0].mimeType.toLowerCase()))for(const e of i.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:p,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r,extmapAllowMixed:!0});const l={type:"answer",sdp:this._remoteSdp.getSdp()};return ra.debug("send() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._mapMidTransceiver.set(d,a),{localId:d,rtpParameters:i,rtpSender:a.sender}}async stopSending(e){ra.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const r=await this._pc.createOffer();ra.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};ra.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?ra.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):ra.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),ra.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated transceiver not found");const s=r.sender.getParameters();t=s.encodings.length-1-t,s.encodings.forEach(((e,r)=>{e.active=r>=t})),await r.sender.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),ra.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.sender.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:i,priority:n};ra.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%sa.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=Wn.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),ra.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};ra.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),ra.debug("receive() [trackId:%s, kind:%s]",e,t);const s=r.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const i={type:"offer",sdp:this._remoteSdp.getSdp()};ra.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Wn.parse(n.sdp),o=a.media.find((e=>String(e.mid)===s));Zn.applyCodecParameters({offerRtpParameters:r,answerMediaObject:o}),n={type:"answer",sdp:Wn.write(a)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:a}),ra.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);const c=this._pc.getTransceivers().find((e=>e.mid===s));if(!c)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,c),{localId:s,track:c.receiver.track,rtpReceiver:c.receiver}}async stopReceiving(e){this._assertRecvDirection(),ra.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};ra.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const s=await this._pc.createAnswer();ra.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a,protocol:r};ra.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};ra.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=Wn.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}ra.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Wn.parse(this._pc.localDescription.sdp));const r=Zn.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}Vn.Firefox60=ia;var na={},aa=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),oa=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),ca=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&aa(t,e,r);return oa(t,e),t};Object.defineProperty(na,"__esModule",{value:!0}),na.Safari12=void 0;const da=ca(Qs),pa=_r,la=ca(Gr),ha=ca(Hr),ua=ca(ci),ma=ca(ui),fa=mi,ga=yi,ya=new pa.Logger("Safari12"),_a={OS:1024,MIS:1024};class ba extends fa.HandlerInterface{constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ba}get name(){return"Safari12"}close(){if(ya.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){ya.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch(e){}const r=da.parse(t.sdp);return ua.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return ya.debug("getNativeSctpCapabilities()"),{numStreams:_a}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){ya.debug("run()"),this._direction=e,this._remoteSdp=new ga.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i}),this._sendingRtpParametersByKind={audio:ha.getSendingRtpParameters("audio",d),video:ha.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:ha.getSendingRemoteRtpParameters("audio",d),video:ha.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){ya.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(ya.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});ya.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};ya.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};ya.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();ya.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),ya.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const i=la.clone(this._sendingRtpParametersByKind[e.kind],{});i.codecs=ha.reduceCodecs(i.codecs,s);const n=la.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});n.codecs=ha.reduceCodecs(n.codecs,s);const a=this._remoteSdp.getNextMediaSectionIdx(),o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let c,d=await this._pc.createOffer(),p=da.parse(d.sdp);this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:p}),t&&t.length>1&&(ya.debug("send() | enabling legacy simulcast"),p=da.parse(d.sdp),c=p.media[a.idx],ma.addLegacySimulcast({offerMediaObject:c,numStreams:t.length}),d={type:"offer",sdp:da.write(p)}),ya.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);const l=o.mid;if(i.mid=l,p=da.parse(this._pc.localDescription.sdp),c=p.media[a.idx],i.rtcp.cname=ua.getCname({offerMediaObject:c}),i.encodings=ma.getRtpEncodings({offerMediaObject:c}),t)for(let e=0;e<i.encodings.length;++e)t[e]&&Object.assign(i.encodings[e],t[e]);if(i.encodings.length>1&&("video/vp8"===i.codecs[0].mimeType.toLowerCase()||"video/h264"===i.codecs[0].mimeType.toLowerCase()))for(const e of i.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:a.reuseMid,offerRtpParameters:i,answerRtpParameters:n,codecOptions:r});const h={type:"answer",sdp:this._remoteSdp.getSdp()};return ya.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(l,o),{localId:l,rtpParameters:i,rtpSender:o.sender}}async stopSending(e){this._assertSendDirection(),ya.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);const r=await this._pc.createOffer();ya.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const s={type:"answer",sdp:this._remoteSdp.getSdp()};ya.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?ya.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):ya.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),ya.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.sender.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),ya.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const s=r.sender.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.sender.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:i,priority:n};ya.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%_a.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=da.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),ya.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};ya.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),ya.debug("receive() [trackId:%s, kind:%s]",e,t);const s=r.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const i={type:"offer",sdp:this._remoteSdp.getSdp()};ya.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=da.parse(n.sdp),o=a.media.find((e=>String(e.mid)===s));ua.applyCodecParameters({offerRtpParameters:r,answerMediaObject:o}),n={type:"answer",sdp:da.write(a)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:a}),ya.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);const c=this._pc.getTransceivers().find((e=>e.mid===s));if(!c)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,c),{localId:s,track:c.receiver.track,rtpReceiver:c.receiver}}async stopReceiving(e){this._assertRecvDirection(),ya.debug("stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);const r={type:"offer",sdp:this._remoteSdp.getSdp()};ya.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);const s=await this._pc.createAnswer();ya.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a,protocol:r};ya.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const e={type:"offer",sdp:this._remoteSdp.getSdp()};ya.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=da.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}ya.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=da.parse(this._pc.localDescription.sdp));const r=ua.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}na.Safari12=ba;var va={},wa=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Sa=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Ra=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&wa(t,e,r);return Sa(t,e),t};Object.defineProperty(va,"__esModule",{value:!0}),va.Safari11=void 0;const Pa=Ra(Qs),Ta=_r,Ca=Ra(Gr),ka=Ra(Hr),Ea=Ra(ci),Da=Ra(hn),xa=mi,Oa=yi,Ma=new Ta.Logger("Safari11"),Ia={OS:1024,MIS:1024};class ja extends xa.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ja}get name(){return"Safari11"}close(){if(Ma.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){Ma.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=Pa.parse(t.sdp);return Ea.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return Ma.debug("getNativeSctpCapabilities()"),{numStreams:Ia}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){Ma.debug("run()"),this._direction=e,this._remoteSdp=new Oa.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,planB:!0}),this._sendingRtpParametersByKind={audio:ka.getSendingRtpParameters("audio",d),video:ka.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:ka.getSendingRemoteRtpParameters("audio",d),video:ka.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){Ma.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(Ma.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});Ma.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};Ma.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};Ma.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();Ma.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),Ma.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),s&&Ma.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let i,n=await this._pc.createOffer(),a=Pa.parse(n.sdp);const o=Ca.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=ka.reduceCodecs(o.codecs);const c=Ca.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(c.codecs=ka.reduceCodecs(c.codecs),this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:a}),"video"===e.kind&&t&&t.length>1&&(Ma.debug("send() | enabling simulcast"),a=Pa.parse(n.sdp),i=a.media.find((e=>"video"===e.type)),Da.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:Pa.write(a)}),Ma.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=Pa.parse(this._pc.localDescription.sdp),i=a.media.find((t=>t.type===e.kind)),o.rtcp.cname=Ea.getCname({offerMediaObject:i}),o.encodings=Da.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<o.encodings.length;++e)t[e]&&Object.assign(o.encodings[e],t[e]);if(o.encodings.length>1&&"video/vp8"===o.codecs[0].mimeType.toLowerCase())for(const e of o.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:o,answerRtpParameters:c,codecOptions:r});const d={type:"answer",sdp:this._remoteSdp.getSdp()};Ma.debug("send() | calling pc.setRemoteDescription() [answer:%o]",d),await this._pc.setRemoteDescription(d);const p=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find((t=>t.track===e));return this._mapSendLocalIdRtpSender.set(p,l),{localId:p,rtpParameters:o,rtpSender:l}}async stopSending(e){this._assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();Ma.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void Ma.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const s={type:"answer",sdp:this._remoteSdp.getSdp()};Ma.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){this._assertSendDirection(),t?Ma.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Ma.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.track;await r.replaceTrack(t),s&&this._sendStream.removeTrack(s),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),Ma.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.setParameters(s)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),Ma.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.setParameters(s)}async getSenderStats(e){this._assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:i,priority:n};Ma.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ia.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=Pa.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),Ma.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};Ma.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),Ma.debug("receive() [trackId:%s, kind:%s]",e,t);const s=e,i=t;this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:r.rtcp.cname,trackId:e});const n={type:"offer",sdp:this._remoteSdp.getSdp()};Ma.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=Pa.parse(a.sdp),c=o.media.find((e=>String(e.mid)===i));Ea.applyCodecParameters({offerRtpParameters:r,answerMediaObject:c}),a={type:"answer",sdp:Pa.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:o}),Ma.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);const d=this._pc.getReceivers().find((e=>e.track&&e.track.id===s));if(!d)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(s,{mid:i,rtpParameters:r,rtpReceiver:d}),{localId:s,track:d.track,rtpReceiver:d}}async stopReceiving(e){this._assertRecvDirection(),Ma.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const s={type:"offer",sdp:this._remoteSdp.getSdp()};Ma.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);const i=await this._pc.createAnswer();Ma.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this._assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a,protocol:r};Ma.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};Ma.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=Pa.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}Ma.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Pa.parse(this._pc.localDescription.sdp));const r=Ea.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}va.Safari11=ja;var La={},Aa={},Ba=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),Fa=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Na=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Ba(t,e,r);return Fa(t,e),t};Object.defineProperty(Aa,"__esModule",{value:!0}),Aa.mangleRtpParameters=Aa.getCapabilities=void 0;const Ua=Na(Gr);Aa.getCapabilities=function(){const e=RTCRtpReceiver.getCapabilities(),t=Ua.clone(e,{});for(const e of t.codecs){if(e.channels=e.numChannels,delete e.numChannels,e.mimeType=e.mimeType||`${e.kind}/${e.name}`,e.parameters){const t=e.parameters;t.apt&&(t.apt=Number(t.apt)),t["packetization-mode"]&&(t["packetization-mode"]=Number(t["packetization-mode"]))}for(const t of e.rtcpFeedback||[])t.parameter||(t.parameter="")}return t},Aa.mangleRtpParameters=function(e){const t=Ua.clone(e,{});t.mid&&(t.muxId=t.mid,delete t.mid);for(const e of t.codecs)e.channels&&(e.numChannels=e.channels,delete e.channels),e.mimeType&&!e.name&&(e.name=e.mimeType.split("/")[1]),delete e.mimeType;return t};var za=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),$a=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Va=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&za(t,e,r);return $a(t,e),t};Object.defineProperty(La,"__esModule",{value:!0}),La.Edge11=void 0;const qa=_r,Ga=$r,Ha=Va(Gr),Wa=Va(Hr),Ka=Va(Aa),Ya=mi,Qa=new qa.Logger("Edge11");class Ja extends Ya.HandlerInterface{constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}static createFactory(){return()=>new Ja}get name(){return"Edge11"}close(){Qa.debug("close()");try{this._iceGatherer.close()}catch(e){}try{this._iceTransport.stop()}catch(e){}try{this._dtlsTransport.stop()}catch(e){}for(const e of this._rtpSenders.values())try{e.stop()}catch(e){}for(const e of this._rtpReceivers.values())try{e.stop()}catch(e){}}async getNativeRtpCapabilities(){return Qa.debug("getNativeRtpCapabilities()"),Ka.getCapabilities()}async getNativeSctpCapabilities(){return Qa.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){Qa.debug("run()"),this._sendingRtpParametersByKind={audio:Wa.getSendingRtpParameters("audio",d),video:Wa.getSendingRtpParameters("video",d)},this._remoteIceParameters=t,this._remoteIceCandidates=r,this._remoteDtlsParameters=s,this._cname=`CNAME-${Ha.generateRandomNumber()}`,this._setIceGatherer({iceServers:n,iceTransportPolicy:a}),this._setIceTransport(),this._setDtlsTransport()}async updateIceServers(e){throw new Ga.UnsupportedError("not supported")}async restartIce(e){if(Qa.debug("restartIce()"),this._remoteIceParameters=e,this._transportReady){Qa.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const e of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(e);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){Qa.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this._setupTransport({localDtlsRole:"server"}),Qa.debug("send() | calling new RTCRtpSender()");const i=new RTCRtpSender(e,this._dtlsTransport),n=Ha.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=Wa.reduceCodecs(n.codecs,s);const a=n.codecs.some((e=>/.+\/rtx$/i.test(e.mimeType)));t||(t=[{}]);for(const e of t)e.ssrc=Ha.generateRandomNumber(),a&&(e.rtx={ssrc:Ha.generateRandomNumber()});n.encodings=t,n.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const o=Ka.mangleRtpParameters(n);Qa.debug("send() | calling rtpSender.send() [params:%o]",o),await i.send(o);const c=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(c,i),{localId:c,rtpParameters:n,rtpSender:i}}async stopSending(e){Qa.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{Qa.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(e){throw Qa.warn("stopSending() | rtpSender.stop() failed:%o",e),e}}async replaceTrack(e,t){t?Qa.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Qa.debug("replaceTrack() [localId:%s, no track]",e);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");r.setTrack(t)}async setMaxSpatialLayer(e,t){Qa.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{e.active=r<=t})),await r.setParameters(s)}async setRtpEncodingParameters(e,t){Qa.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const s=r.getParameters();s.encodings.forEach(((e,r)=>{s.encodings[r]=Object.assign(Object.assign({},e),t)})),await r.setParameters(s)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new Ga.UnsupportedError("not implemented")}async receive({trackId:e,kind:t,rtpParameters:r}){Qa.debug("receive() [trackId:%s, kind:%s]",e,t),this._transportReady||await this._setupTransport({localDtlsRole:"server"}),Qa.debug("receive() | calling new RTCRtpReceiver()");const s=new RTCRtpReceiver(this._dtlsTransport,t);s.addEventListener("error",(e=>{Qa.error('rtpReceiver "error" event [event:%o]',e)}));const i=Ka.mangleRtpParameters(r);Qa.debug("receive() | calling rtpReceiver.receive() [params:%o]",i),await s.receive(i);const n=e;return this._rtpReceivers.set(n,s),{localId:n,track:s.track,rtpReceiver:s}}async stopReceiving(e){Qa.debug("stopReceiving() [localId:%s]",e);const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(e);try{Qa.debug("stopReceiving() | calling rtpReceiver.stop()"),t.stop()}catch(e){Qa.warn("stopReceiving() | rtpReceiver.stop() failed:%o",e)}}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new Ga.UnsupportedError("not implemented")}_setIceGatherer({iceServers:e,iceTransportPolicy:t}){const r=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});r.addEventListener("error",(e=>{Qa.error('iceGatherer "error" event [event:%o]',e)}));try{r.gather()}catch(e){Qa.debug("_setIceGatherer() | iceGatherer.gather() failed: %s",e.toString())}this._iceGatherer=r}_setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",(()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})),e.addEventListener("icestatechange",(()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})),e.addEventListener("candidatepairchange",(e=>{Qa.debug('iceTransport "candidatepairchange" event [pair:%o]',e.pair)})),this._iceTransport=e}_setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",(()=>{Qa.debug('dtlsTransport "statechange" event [state:%s]',e.state)})),e.addEventListener("dtlsstatechange",(()=>{Qa.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),"closed"===e.state&&this.emit("@connectionstatechange","closed")})),e.addEventListener("error",(e=>{Qa.error('dtlsTransport "error" event [event:%o]',e)})),this._dtlsTransport=e}async _setupTransport({localDtlsRole:e}){Qa.debug("_setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await this.safeEmitAsPromise("@connect",{dtlsParameters:t}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const e of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(e);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter((e=>"sha-256"===e.algorithm||"sha-384"===e.algorithm||"sha-512"===e.algorithm)),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}La.Edge11=Ja;var Za={},Xa=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),eo=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),to=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&Xa(t,e,r);return eo(t,e),t};Object.defineProperty(Za,"__esModule",{value:!0}),Za.ReactNative=void 0;const ro=to(Qs),so=_r,io=$r,no=to(Gr),ao=to(Hr),oo=to(ci),co=to(hn),po=mi,lo=yi,ho=new so.Logger("ReactNative"),uo={OS:1024,MIS:1024};class mo extends po.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new mo}get name(){return"ReactNative"}close(){if(ho.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){ho.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const r=ro.parse(t.sdp);return oo.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return ho.debug("getNativeSctpCapabilities()"),{numStreams:uo}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,extendedRtpCapabilities:d}){ho.debug("run()"),this._direction=e,this._remoteSdp=new lo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,planB:!0}),this._sendingRtpParametersByKind={audio:ao.getSendingRtpParameters("audio",d),video:ao.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:ao.getSendingRemoteRtpParameters("audio",d),video:ao.getSendingRemoteRtpParameters("video",d)},this._pc=new RTCPeerConnection(Object.assign({iceServers:n||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),c),this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}))}async updateIceServers(e){ho.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(ho.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});ho.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};ho.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};ho.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();ho.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:s}){this._assertSendDirection(),ho.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),s&&ho.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let i,n=await this._pc.createOffer(),a=ro.parse(n.sdp);const o=no.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=ao.reduceCodecs(o.codecs);const c=no.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(c.codecs=ao.reduceCodecs(c.codecs),this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:a}),"video"===e.kind&&t&&t.length>1&&(ho.debug("send() | enabling simulcast"),a=ro.parse(n.sdp),i=a.media.find((e=>"video"===e.type)),co.addLegacySimulcast({offerMediaObject:i,track:e,numStreams:t.length}),n={type:"offer",sdp:ro.write(a)}),ho.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),a=ro.parse(this._pc.localDescription.sdp),i=a.media.find((t=>t.type===e.kind)),o.rtcp.cname=oo.getCname({offerMediaObject:i}),o.encodings=co.getRtpEncodings({offerMediaObject:i,track:e}),t)for(let e=0;e<o.encodings.length;++e)t[e]&&Object.assign(o.encodings[e],t[e]);if(o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||"video/h264"===o.codecs[0].mimeType.toLowerCase()))for(const e of o.encodings)e.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:i,offerRtpParameters:o,answerRtpParameters:c,codecOptions:r});const d={type:"answer",sdp:this._remoteSdp.getSdp()};ho.debug("send() | calling pc.setRemoteDescription() [answer:%o]",d),await this._pc.setRemoteDescription(d);const p=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(p,e),{localId:p,rtpParameters:o}}async stopSending(e){this._assertSendDirection(),ho.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();ho.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(e){if(0===this._sendStream.getTracks().length)return void ho.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const s={type:"answer",sdp:this._remoteSdp.getSdp()};ho.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}async replaceTrack(e,t){throw new io.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new io.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new io.UnsupportedError("not implemented")}async getSenderStats(e){throw new io.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:s,protocol:i,priority:n}){this._assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:i,priority:n};ho.debug("sendDataChannel() [options:%o]",a);const o=this._pc.createDataChannel(s,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%uo.MIS,!this._hasDataChannelMediaSection){const e=await this._pc.createOffer(),t=ro.parse(e.sdp),r=t.media.find((e=>"application"===e.type));this._transportReady||await this._setupTransport({localDtlsRole:"server",localSdpObject:t}),ho.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e),this._remoteSdp.sendSctpAssociation({offerMediaObject:r});const s={type:"answer",sdp:this._remoteSdp.getSdp()};ho.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s),this._hasDataChannelMediaSection=!0}return{dataChannel:o,sctpStreamParameters:{streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits}}}async receive({trackId:e,kind:t,rtpParameters:r}){this._assertRecvDirection(),ho.debug("receive() [trackId:%s, kind:%s]",e,t);const s=e,i=t;let n=r.rtcp.cname;ho.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),n+=`-hack-${no.generateRandomNumber()}`,this._remoteSdp.receive({mid:i,kind:t,offerRtpParameters:r,streamId:n,trackId:e});const a={type:"offer",sdp:this._remoteSdp.getSdp()};ho.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);let o=await this._pc.createAnswer();const c=ro.parse(o.sdp),d=c.media.find((e=>String(e.mid)===i));oo.applyCodecParameters({offerRtpParameters:r,answerMediaObject:d}),o={type:"answer",sdp:ro.write(c)},this._transportReady||await this._setupTransport({localDtlsRole:"client",localSdpObject:c}),ho.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);const p=this._pc.getRemoteStreams().find((e=>e.id===n)).getTrackById(s);if(!p)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(s,{mid:i,rtpParameters:r}),{localId:s,track:p}}async stopReceiving(e){this._assertRecvDirection(),ho.debug("stopReceiving() [localId:%s]",e);const{mid:t,rtpParameters:r}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:r});const s={type:"offer",sdp:this._remoteSdp.getSdp()};ho.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",s),await this._pc.setRemoteDescription(s);const i=await this._pc.createAnswer();ho.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){throw new io.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this._assertRecvDirection();const{streamId:s,ordered:i,maxPacketLifeTime:n,maxRetransmits:a}=e,o={negotiated:!0,id:s,ordered:i,maxPacketLifeTime:n,maxRetransmitTime:n,maxRetransmits:a,protocol:r};ho.debug("receiveDataChannel() [options:%o]",o);const c=this._pc.createDataChannel(t,o);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const e={type:"offer",sdp:this._remoteSdp.getSdp()};ho.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();if(!this._transportReady){const e=ro.parse(t.sdp);await this._setupTransport({localDtlsRole:"client",localSdpObject:e})}ho.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setLocalDescription(t),this._hasDataChannelMediaSection=!0}return{dataChannel:c}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ro.parse(this._pc.localDescription.sdp));const r=oo.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole("client"===e?"server":"client"),await this.safeEmitAsPromise("@connect",{dtlsParameters:r}),this._transportReady=!0}_assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}Za.ReactNative=mo;var fo=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),go=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),yo=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&fo(t,e,r);return go(t,e),t},_o=C&&C.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ir,"__esModule",{value:!0}),ir.Device=ir.detectDevice=void 0;const bo=_o(yr),vo=_r,wo=Rr,So=$r,Ro=yo(Gr),Po=yo(Hr),To=hs,Co=Ys,ko=Ki,Eo=ln,Do=kn,xo=Vn,Oo=na,Mo=va,Io=La,jo=Za,Lo=new vo.Logger("Device");function Ao(){if("object"==typeof navigator&&"ReactNative"===navigator.product)return"undefined"==typeof RTCPeerConnection?void Lo.warn("this._detectDevice() | unsupported ReactNative without RTCPeerConnection"):(Lo.debug("this._detectDevice() | ReactNative handler chosen"),"ReactNative");if("object"!=typeof navigator||"string"!=typeof navigator.userAgent)Lo.warn("this._detectDevice() | unknown device");else{const e=navigator.userAgent,t=bo.default.getParser(e),r=t.getEngine();if(t.satisfies({chrome:">=74",chromium:">=74"}))return"Chrome74";if(t.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(t.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(t.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(t.satisfies({firefox:">=60"}))return"Firefox60";if(t.satisfies({safari:">=12.0"})&&"undefined"!=typeof RTCRtpTransceiver&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(t.satisfies({safari:">=11"}))return"Safari11";if(t.satisfies({"microsoft edge":">=11"})&&t.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(r.name&&"blink"===r.name.toLowerCase()){const t=e.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(t){const e=Number(t[1]);return e>=74?"Chrome74":e>=70?"Chrome70":e>=67?"Chrome67":"Chrome55"}return"Chrome74"}Lo.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",t.getBrowserName(),t.getBrowserVersion())}}ir.detectDevice=Ao;ir.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:r}={}){if(this._loaded=!1,this._observer=new wo.EnhancedEventEmitter,Lo.debug("constructor()"),r){if(Lo.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof r)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=r}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)Lo.debug("constructor() | handler given: %s",e);else{if(!(e=Ao()))throw new So.UnsupportedError("device not supported");Lo.debug("constructor() | detected handler: %s",e)}switch(e){case"Chrome74":this._handlerFactory=Co.Chrome74.createFactory();break;case"Chrome70":this._handlerFactory=ko.Chrome70.createFactory();break;case"Chrome67":this._handlerFactory=Eo.Chrome67.createFactory();break;case"Chrome55":this._handlerFactory=Do.Chrome55.createFactory();break;case"Firefox60":this._handlerFactory=xo.Firefox60.createFactory();break;case"Safari12":this._handlerFactory=Oo.Safari12.createFactory();break;case"Safari11":this._handlerFactory=Mo.Safari11.createFactory();break;case"Edge11":this._handlerFactory=Io.Edge11.createFactory();break;case"ReactNative":this._handlerFactory=jo.ReactNative.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}const s=this._handlerFactory();this._handlerName=s.name,s.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new So.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new So.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){let t;Lo.debug("load() [routerRtpCapabilities:%o]",e),e=Ro.clone(e,void 0);try{if(this._loaded)throw new So.InvalidStateError("already loaded");Po.validateRtpCapabilities(e),t=this._handlerFactory();const r=await t.getNativeRtpCapabilities();Lo.debug("load() | got native RTP capabilities:%o",r),Po.validateRtpCapabilities(r),this._extendedRtpCapabilities=Po.getExtendedRtpCapabilities(r,e),Lo.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=Po.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=Po.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=Po.getRecvRtpCapabilities(this._extendedRtpCapabilities),Po.validateRtpCapabilities(this._recvRtpCapabilities),Lo.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),Lo.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),Po.validateSctpCapabilities(this._sctpCapabilities),Lo.debug("load() succeeded"),this._loaded=!0,t.close()}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new So.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,appData:d={}}){return Lo.debug("createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,appData:d})}createRecvTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,appData:d={}}){return Lo.debug("createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:s,sctpParameters:i,iceServers:n,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:c,appData:d})}_createTransport({direction:e,id:t,iceParameters:r,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,appData:p={}}){if(!this._loaded)throw new So.InvalidStateError("not loaded");if("string"!=typeof t)throw new TypeError("missing id");if("object"!=typeof r)throw new TypeError("missing iceParameters");if(!Array.isArray(s))throw new TypeError("missing iceCandidates");if("object"!=typeof i)throw new TypeError("missing dtlsParameters");if(n&&"object"!=typeof n)throw new TypeError("wrong sctpParameters");if(p&&"object"!=typeof p)throw new TypeError("if given, appData must be an object");const l=new To.Transport({direction:e,id:t,iceParameters:r,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:d,appData:p,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",l),l}};var Bo={},Fo={};Object.defineProperty(Fo,"__esModule",{value:!0});var No={};Object.defineProperty(No,"__esModule",{value:!0}),function(e){var t=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),r=C&&C.__exportStar||function(e,r){for(var s in e)"default"===s||r.hasOwnProperty(s)||t(r,e,s)};Object.defineProperty(e,"__esModule",{value:!0}),r(ir,e),r(hs,e),r(fs,e),r(vs,e),r(Ts,e),r(xs,e),r(Fo,e),r(No,e),r(mi,e),r($r,e)}(Bo),function(e){var t=C&&C.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),r=C&&C.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=C&&C.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var i in e)"default"!==i&&Object.hasOwnProperty.call(e,i)&&t(s,e,i);return r(s,e),s};Object.defineProperty(e,"__esModule",{value:!0}),e.detectDevice=e.Device=e.version=e.types=void 0;const i=ir;Object.defineProperty(e,"Device",{enumerable:!0,get:function(){return i.Device}}),Object.defineProperty(e,"detectDevice",{enumerable:!0,get:function(){return i.detectDevice}});const n=s(Bo);e.types=n,e.version="3.6.29";var a=Oi;Object.defineProperty(e,"parseScalabilityMode",{enumerable:!0,get:function(){return a.parse}})}(sr);class Uo extends Gt{constructor(e){super(),this.url=e,this.seq=0,this.lockReconnect=!1,this.maxCount=5,this.gap=2e3,this.cc=0,this.isReconnect=!1,this.connect(e)}connect(e){this.ws=new WebSocket(e),this.ws.addEventListener("open",(()=>this.open())),this.ws.addEventListener("message",(e=>this.message(e))),this.ws.addEventListener("close",(e=>this.close(e))),this.ws.addEventListener("error",(e=>this.error(e)))}open(){this.emit("open"),this.isReconnect&&this.emit("reconnect"),this.isReconnect=!0,this.cc=0}message(e){this.emit("message",e);const{type:t,data:r}=JSON.parse(e.data);"notify"!==t&&r.code!==zt&&this.emit("unexpected",r)}close(e){this.reconnect(this.url),this.emit("close",e)}error(e){this.emit("error",e)}destroy(){this.ws&&(this.ws.close(),this.lockReconnect=!0,this.ws.onmessage=null,this.ws.onopen=null,this.ws.onclose=null,this.removeAllListeners(),delete this.ws)}request(e,t={}){const r=this.seq++,s={time:Date.now(),seq:r,type:"request",eventType:e,data:t};return this.ws&&this.ws.send(JSON.stringify(s)),new Promise(((t,s)=>{this.on("message",(i=>{const{data:n,seq:a,type:o,eventType:c}=JSON.parse(i.data);a===r&&"response"===o&&c===e&&(n.code===zt?t(n):s(n))}))}))}opened(){return new Promise((e=>{this.on("open",e)}))}reconnect(e){this.lockReconnect||(this.cc>=this.maxCount?this.emit("reconnectFail"):(this.lockReconnect=!0,setTimeout((()=>{this.cc++,this.connect(e),this.lockReconnect=!1}),this.gap)))}}const zo=new Dt("SendSignaling");class $o extends sr.Device{constructor({host:e,streamId:t,token:r}){zo.debug("constructor() [host: %s, streamId: %s, token: %s]",e,t,r),super(),this.socket=new Uo(`wss://${e}/api/v1/mdc-rtc-media?streamId=${t}&userToken=${r}`),this.socket.on("reconnect",(()=>this.restartIce()))}getTransport(){return this.transport}getProducer(){return[this.videoProducer,this.audioProducer]}connect(){return jt(this,void 0,void 0,(function*(){zo.debug("connect()"),yield this.socket.opened()}))}createStream(){return jt(this,void 0,void 0,(function*(){zo.debug("createStream()");const{result:{rtpCapabilities:e}}=yield this.socket.request("CREATE_STREAM");if(this.loaded||(yield this.load({routerRtpCapabilities:e})),!this.canProduce("video"))throw new Error(JSON.stringify(Kt))}))}createSendWebrtcTransport(){return jt(this,void 0,void 0,(function*(){zo.debug("createSendWebrtcTransport()");const{result:e}=yield this.socket.request("CREATE_WEBRTC_TRANSPORT",{sctpCapabilities:this.sctpCapabilities});this.transport=this.createSendTransport(e)}))}connectWebrtcTransport(){var e;return jt(this,void 0,void 0,(function*(){zo.debug("connectWebrtcTransport()"),null===(e=this.transport)||void 0===e||e.on("connect",(({dtlsParameters:e},t,r)=>jt(this,void 0,void 0,(function*(){var s;yield this.socket.request("CONNECT_WEBRTC_TRANSPORT",{transportId:null===(s=this.transport)||void 0===s?void 0:s.id,dtlsParameters:e}).then(t).catch(r)}))))}))}createProducers([e,t]){var r,s,i,n,a;return jt(this,void 0,void 0,(function*(){zo.debug("createProducers()");const o=[];let c;null===(r=this.transport)||void 0===r||r.on("produce",(({kind:e,rtpParameters:t},r)=>{o.push({kind:e,rtpParameters:t}),r({id:Math.random()+""})})),this.transport.on("producedata",(({sctpStreamParameters:e,label:t,protocol:r,appData:s},i)=>{c={sctpStreamParameters:e,label:t,protocol:r,appData:s},i({id:Math.random()+""})})),this.videoProducer=yield null===(s=this.transport)||void 0===s?void 0:s.produce({track:e}),this.audioProducer=yield null===(i=this.transport)||void 0===i?void 0:i.produce({track:t}),this.dataProducer=yield null===(n=this.transport)||void 0===n?void 0:n.produceData({ordered:!0}),yield this.socket.request("CREATE_PRODUCERS",{transportId:null===(a=this.transport)||void 0===a?void 0:a.id,producersOptions:o,dataProducerOptions:c})}))}closeStream(){return jt(this,void 0,void 0,(function*(){return zo.debug("closeStream()"),this.socket.request("CLOSE_STREAM")}))}restartIce(){var e,t;return jt(this,void 0,void 0,(function*(){zo.debug("restartIce()");const{result:{iceParameters:r}}=yield this.socket.request("RESTART_ICE",{transportId:null===(e=this.transport)||void 0===e?void 0:e.id});yield null===(t=this.transport)||void 0===t?void 0:t.restartIce({iceParameters:r})}))}destroy(){return jt(this,void 0,void 0,(function*(){zo.debug("destroy()"),yield this.closeStream(),this.socket.destroy()}))}}const Vo=new Dt("RecvSignaling");class qo extends sr.Device{constructor({host:e,streamId:t,token:r}){Vo.debug("constructor() [host: %s, streamId: %s, token: %s]",e,t,r),super(),this.socket=new Uo(`wss://${e}/api/v1/mdc-rtc-media?streamId=${t}&userToken=${r}`)}getTransport(){return this.transport}getConsumer(){return[this.videoConsumer,this.audioConsumer]}connect(){return jt(this,void 0,void 0,(function*(){Vo.debug("connect()"),yield this.socket.opened()}))}connectWebrtcTransport(){var e;return jt(this,void 0,void 0,(function*(){Vo.debug("connectWebrtcTransport()"),null===(e=this.transport)||void 0===e||e.on("connect",(({dtlsParameters:e},t,r)=>jt(this,void 0,void 0,(function*(){var s;yield this.socket.request("CONNECT_WEBRTC_TRANSPORT",{transportId:null===(s=this.transport)||void 0===s?void 0:s.id,dtlsParameters:e}).then(t).catch(r)}))))}))}getRouterRtpCapabilities(){return jt(this,void 0,void 0,(function*(){Vo.debug("getRouterRtpCapabilities()");const{result:{rtpCapabilities:e}}=yield this.socket.request("GET_ROUTER_RTP_CAPABILITIES");this.loaded||(yield this.load({routerRtpCapabilities:e})),this.canProduce("video")||console.warn("cannot produce video")}))}createRecvWebrtcTransport(){return jt(this,void 0,void 0,(function*(){Vo.debug("createRecvWebrtcTransport()");const{result:e}=yield this.socket.request("CREATE_WEBRTC_TRANSPORT",{sctpCapabilities:this.sctpCapabilities});this.transport=this.createRecvTransport(e)}))}createConsumers(){var e,t,r;return jt(this,void 0,void 0,(function*(){Vo.debug("createConsumers()");const{result:{consumersInfo:[s,i],dataConsumerInfo:n}}=yield this.socket.request("CREATE_CONSUMERS",{transportId:null===(e=this.transport)||void 0===e?void 0:e.id,consumersOptions:[{kind:"video",rtpCapabilities:this.rtpCapabilities},{kind:"audio",rtpCapabilities:this.rtpCapabilities}]});this.videoConsumer=yield null===(t=this.transport)||void 0===t?void 0:t.consume(s),this.audioConsumer=yield null===(r=this.transport)||void 0===r?void 0:r.consume(i),n&&(this.dataConsumer=yield this.transport.consumeData({id:n.id,dataProducerId:n.dataProducerId,sctpStreamParameters:n.sctpStreamParameters,label:n.label,protocol:n.protocol}))}))}restartIce(){var e,t;return jt(this,void 0,void 0,(function*(){Vo.debug("restartIce()");const{result:{iceParameters:r}}=yield this.socket.request("RESTART_ICE",{transportId:null===(e=this.transport)||void 0===e?void 0:e.id});yield null===(t=this.transport)||void 0===t?void 0:t.restartIce({iceParameters:r})}))}closeTransport(){var e;return jt(this,void 0,void 0,(function*(){Vo.debug("closeTransport()"),yield this.socket.request("CLOSE_WEBRTC_TRANSPORT",{transportId:null===(e=this.transport)||void 0===e?void 0:e.id})}))}destroy(){return jt(this,void 0,void 0,(function*(){Vo.debug("destroy()"),yield this.closeTransport(),this.socket.destroy()}))}}const Go=new Dt("Client");function Ho(e){let t=e;const r=(s=e,Nt("string")(s));var s;if(r)try{t=JSON.parse(e)}catch(e){}if(Ut(t))return Ft([t]);if((e=>Nt("array")(e))(t)&&t.every((e=>Ut(e))))return r?t:Ft(t);throw new Error(Ft(tr))}class Wo extends Gt{constructor(e){super(),this.config=e,this.sendSignaling=null,this.recvSignaling=null,this.stats=new rr,window.onbeforeunload=()=>this.unpublish(),Go.debug("constructor() [config: %o]",e)}publish(e){return jt(this,void 0,void 0,(function*(){if(Go.debug("publish() [tracks: %o]",e),this.sendSignaling)throw new Error(Ft(Yt));const{host:t,streamId:r,token:s}=yield Vt(Object.assign(Object.assign({},this.config),{operateType:"push"})).catch((e=>{throw Go.error("publish error: %o",e),new Error(Ft(e))})),i=new $o({host:t,streamId:r,token:s});try{yield i.connect(),yield i.createStream(),yield i.createSendWebrtcTransport(),yield i.connectWebrtcTransport(),yield i.createProducers(Wo.formatTracks(e))}catch(e){throw Go.error("publish error: %o",e),this.emit("error",e),e}this.sendSignaling=i,i.socket.on("reconnect",(()=>i.restartIce())),i.socket.on("reconnectFail",(()=>this.recvSignaling=null)),i.socket.on("unexpected",(e=>this.emit("error",e))),Go.debug("publish success")}))}unpublish(){return jt(this,void 0,void 0,(function*(){if(Go.debug("unpublish()"),!this.sendSignaling)throw new Error(Ft(Qt));yield this.sendSignaling.destroy(),this.sendSignaling=null}))}subscribe(){return jt(this,void 0,void 0,(function*(){if(Go.debug("subscribe()"),this.recvSignaling)throw new Error(Ft(Jt));const{host:e,streamId:t,token:r}=yield Vt(Object.assign(Object.assign({},this.config),{operateType:"pull"})).catch((e=>{throw Go.error("subscribe error: %o",e),new Error(Ft(e))})),s=new qo({host:e,streamId:t,token:r});try{yield s.connect(),yield s.getRouterRtpCapabilities(),yield s.createRecvWebrtcTransport(),yield s.connectWebrtcTransport(),yield s.createConsumers()}catch(e){throw Go.error("subscribe error: %o",e),this.emit("error",e),e}this.recvSignaling=s,s.socket.on("reconnect",(()=>s.restartIce())),s.socket.on("reconnectFail",(()=>this.recvSignaling=null)),s.socket.on("unexpected",(()=>this.recvSignaling=null));const i=s.getConsumer().map((e=>e.track));return s.dataConsumer&&(s.dataConsumer.on("open",(()=>{Go.debug('DataConsumer "open" event')})),s.dataConsumer.on("message",(e=>{Go.debug('DataConsumer "message" event: %o',e),this.emit("message",e)}))),Go.debug("subscribe success [tracks: %o]",i),i}))}unsubscribe(){return jt(this,void 0,void 0,(function*(){if(!this.recvSignaling)throw new Error(Ft(Zt));try{yield this.recvSignaling.destroy()}catch(e){this.emit("error",e)}this.recvSignaling=null}))}replaceTrack(e){return jt(this,void 0,void 0,(function*(){if(!this.sendSignaling)throw new Error(Ft(Qt));if(!Bt(e))throw new Error(Ft(Ht));const[t,r]=this.sendSignaling.getProducer();if("video"===e.kind){if(!t)throw new Error(Ft(Wt));yield t.replaceTrack({track:e})}if("audio"===e.kind){if(!r)throw new Error(Ft(Wt));yield r.replaceTrack({track:e})}}))}getStats(){var e,t;if(!this.sendSignaling&&!this.recvSignaling)throw new Error(Ft(er));const r=null===(e=this.sendSignaling)||void 0===e?void 0:e.getTransport(),s=null===(t=this.recvSignaling)||void 0===t?void 0:t.getTransport();return this.stats.getTransportStats(r,s)}getLocalAudioStats(){if(!this.sendSignaling)throw new Error(Ft(Qt));const[,e]=this.sendSignaling.getProducer();if(e)return this.stats.getProducerAudioStats(e);throw new Error(Ft(Xt))}getLocalVideoStats(){if(!this.sendSignaling)throw new Error(Ft(Qt));const[e]=this.sendSignaling.getProducer();if(e)return this.stats.getProducerVideoStats(e);throw new Error(Ft(Xt))}getRemoteAudioStats(){if(!this.recvSignaling)throw new Error(Ft(Zt));const[,e]=this.recvSignaling.getConsumer();if(e)return this.stats.getConsumerAudioStats(e);throw new Error(Ft(Xt))}getRemoteVideoStats(){if(!this.recvSignaling)throw new Error(Ft(Zt));const[e]=this.recvSignaling.getConsumer();if(e)return this.stats.getConsumerVideoStats(e);throw new Error(Ft(Xt))}static formatTracks(e){if(!Array.isArray(e)||0===e.length)throw new Error(Ft(Ht));e.forEach((e=>{if(!Bt(e))throw new Error(Ft(Ht))}));const{createEmptyVideoTrack:t,createEmptyAudioTrack:r}=new xt;return[e.find((e=>"video"===e.kind))||t(),e.find((e=>"audio"===e.kind))||r()]}sendCustomMessage(e){if(Go.debug("sendCustomMessage() [message: %o]",e),!this.sendSignaling)throw new Error(Ft(Qt));this.sendSignaling.dataProducer.send(Ho(e))}}var Ko="1.0.0";new Dt("Initializer").debug("sdk version: %s",Ko);const Yo=new class{getMediaDevices(){return navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((()=>navigator.mediaDevices.enumerateDevices()))}getCameras(){return this.getMediaDevices().then((t=>e(t,"videoinput")))}getMicrophones(){return this.getMediaDevices().then((t=>e(t,"audioinput")))}},Qo=new xt,{createCameraAndMicTracks:Jo,createScreenTracks:Zo,createCameraTrack:Xo,createMicTrack:ec,createVideoElementTracks:tc,createAudioElementTrack:rc,createCanvasTrack:sc,createEmptyAudioTrack:ic,createEmptyVideoTrack:nc,mixAudioTracks:ac}=Qo;return{createClient:function(e){return new Wo(e)},getMediaDevices:()=>Yo.getMediaDevices(),getCameras:()=>Yo.getCameras(),getMicrophones:()=>Yo.getMicrophones(),createCameraAndMicTracks:Jo,createScreenTracks:Zo,createCameraTrack:Xo,createMicTrack:ec,createVideoElementTracks:tc,createAudioElementTrack:rc,createCanvasTrack:sc,createEmptyAudioTrack:ic,createEmptyVideoTrack:nc,mixAudioTracks:ac}}));
